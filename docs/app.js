"use strict";(()=>{"use strict";const e=JSON.parse("{\"trackPieces\":[{\"gradient\":[1,0],\"delta\":[0,0],\"width\":20,\"color\":\"black\",\"flyoverPoint\":true},{\"gradient\":[1,0],\"delta\":[150,0],\"width\":20,\"rail\":[[0.5,1.75],[0.25,0.75]],\"flyoverPoint\":true},{\"gradient\":[1,2],\"delta\":[50,30],\"width\":20,\"rail\":[[1,1],[0.6,0.25]]},{\"gradient\":[1,2],\"delta\":[30,60],\"width\":20,\"rail\":[0.5,0.25]},{\"gradient\":[0,1],\"delta\":[8,30],\"width\":20,\"rail\":[[0.5,0.1],[0.25,0.1]]},{\"gradient\":[0,1],\"delta\":[0,20],\"width\":20,\"rail\":[[1.5,2.5],[0.125,0.75]],\"flyoverPoint\":true},{\"gradient\":[-1,0],\"delta\":[-50,50],\"width\":20,\"rail\":[[1.5,1.5],[1,0.125]]},{\"gradient\":[-5,-1],\"delta\":[-60,-10],\"width\":20,\"rail\":[[0.25,1.2],[0.25,2.5]]},{\"gradient\":[-2,3],\"delta\":[-70,40],\"width\":20,\"rail\":[[0.5,2],[0.75,1.5]]},{\"gradient\":[-3,-2],\"delta\":[-70,20],\"width\":20,\"rail\":[[2,0.5],[0.25,0.16667]],\"flyoverPoint\":true},{\"gradient\":[-3,-2],\"delta\":[-60,-40],\"width\":20,\"rail\":[[0.25,0.5],[1,2]]},{\"gradient\":[-2,3],\"delta\":[-70,10],\"width\":20,\"rail\":[[1,0.25],[1.5,0.1]]},{\"gradient\":[-2,3],\"delta\":[-10,15],\"width\":20,\"rail\":[[0.1,2],[0.1,1]]},{\"gradient\":[-3,-2],\"delta\":[-70,20],\"width\":20,\"rail\":[[1.5,0.25],[0.6,0.25]]},{\"gradient\":[-3,-2],\"delta\":[-60,-40],\"width\":20,\"rail\":[[0.25,1],[0.25,2]]},{\"gradient\":[-1,0],\"delta\":[-60,-25],\"width\":20,\"rail\":[[0.7,1],[1,2]]},{\"gradient\":[-1,1],\"delta\":[-55,20],\"width\":20,\"rail\":[[0.2,0.2],[0.75,1]]},{\"gradient\":[-1,0],\"delta\":[-70,40],\"width\":20,\"rail\":[[2,2.5],[1,1.5]],\"flyoverPoint\":true},{\"gradient\":[0,-1],\"delta\":[-80,-70],\"width\":20,\"rail\":[[3,1.2],[1.7,0.75]]},{\"gradient\":[0,-1],\"delta\":[0,-80],\"width\":20,\"rail\":[[1,3],[1,2]],\"color\":\"lightgreen\",\"flyoverPoint\":true},{\"gradient\":[1,0],\"delta\":[90,-90],\"width\":20,\"rail\":[[3,1],[2,1]],\"flyoverPoint\":true},{\"gradient\":[1,0],\"delta\":[90,0],\"width\":20},{\"gradient\":[1,0],\"delta\":[90,0],\"width\":20},{\"gradient\":[1,0],\"delta\":[90,0],\"width\":20},{\"gradient\":[1,0],\"delta\":[90,0],\"width\":20}],\"grandStand\":{\"trackEdge\":-20,\"sideHeight\":2,\"front\":-50,\"back\":-250,\"left\":-400,\"right\":100,\"height\":100}}"),t=JSON.parse("{\"trackPieces\":[{\"gradient\":[1,0],\"delta\":[0,0],\"width\":20,\"color\":\"black\"},{\"gradient\":[1,0],\"delta\":[20,0],\"width\":20,\"rail\":[1,0.25]},{\"gradient\":[1,1],\"delta\":[27,13],\"width\":20,\"rail\":[1,0.25]},{\"gradient\":[0,1],\"delta\":[13,27],\"width\":20,\"rail\":[1,0.25]},{\"gradient\":[-1,1],\"delta\":[-13,27],\"width\":20,\"rail\":[1,0.25]},{\"gradient\":[-1,0],\"delta\":[-27,13],\"width\":20,\"rail\":[1,0.25],\"color\":\"lightgreen\"},{\"gradient\":[-1,0],\"delta\":[-120,0],\"width\":20,\"rail\":[1,0.25]},{\"gradient\":[-1,-1],\"delta\":[-27,-13],\"width\":20,\"rail\":[1,0.25]},{\"gradient\":[0,-1],\"delta\":[-13,-27],\"width\":20,\"rail\":[1,0.25]},{\"gradient\":[1,-1],\"delta\":[13,-27],\"width\":20,\"rail\":[1,0.25]},{\"gradient\":[1,0],\"delta\":[27,-13],\"width\":20,\"rail\":[1,0.25]}],\"grandStand\":{\"trackEdge\":-20,\"sideHeight\":2,\"front\":-30,\"back\":-100,\"left\":-105,\"right\":25,\"height\":35}}");function n(e){return function(e){if(Array.isArray(e))return a(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return a(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?a(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function a(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=Array(t);n<t;n++)a[n]=e[n];return a}var r=1/7;function i(e){var t=this;Object.assign(this,{gradient:[1,0],delta:[0,0],width:20,rail:[.5,.5]},e);var a=Math.hypot.apply(Math,n(this.gradient)),i=Math.acos(this.gradient[0]/a);this.gradient[1]<0&&(i=2*Math.PI-i),this.α=i,this.force=function(){var e=[],a=t;function i(t){e.forEach(function(e){if(0!==e.trackAhead.length&&e.trackAhead[0]===a){var i=Math.hypot(e.vx,e.vy),o=[e.vx/i,e.vy/i],s=a.gradient.map(function(e){return e/Math.hypot.apply(Math,n(a.gradient))}),c=[s[0]-o[0],s[1]-o[1]],l=Math.acos((c[0]*o[0]+c[1]*o[1])/Math.hypot.apply(Math,n(c)));(Number.isNaN(l)||180*l/Math.PI<Number.EPSILON)&&(c=[0,0]);var d=Math.hypot.apply(Math,n(c));d>1?c=c.map(function(e){return e/d*.02}):d>0&&(c=c.map(function(e){return .02*e})),c=c.map(function(e,t){return e+s[t]*r}),e.vx+=c[0]*t,e.vy+=c[1]*t;var h=[e.x+e.vx,e.y+e.vy];if(Number.isFinite(a.m)&&Number.isFinite(a.b)&&0!==a.α&&a.α!==Math.PI&&a.α!==2*Math.PI){var m=a.m*h[0]+a.b;a.α>0&&a.α<Math.PI&&m<=h[1]&&(e.nextPiece=!0),a.α>Math.PI&&m>=h[1]&&(e.nextPiece=!0)}else 0===a.α&&a.x<h[0]&&(e.nextPiece=!0),a.α===Math.PI&&a.x>h[0]&&(e.nextPiece=!0);var u=e.trackAhead.slice(-1).pop();if(Number.isFinite(u.m)&&Number.isFinite(u.b)&&0!==u.α&&u.α!==Math.PI&&u.α!==2*Math.PI){var p=u.m*e.x+u.b;u.α>0&&u.α<Math.PI&&p>e.y&&(e.previousPiece=!0),u.α>Math.PI&&p<e.y&&(e.previousPiece=!0)}else 0===u.α&&u.x>e.x&&(e.previousPiece=!0),u.α===Math.PI&&u.x<e.x&&(e.previousPiece=!0);e.previousPiece&&(e.nextPiece=!1)}})}return i.initialize=function(t){e=t},i}()}function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=Array(t);n<t;n++)a[n]=e[n];return a}function s(e){var t=[];function n(n){e.forEach(function(e){t.forEach(function(t){var n,a=function(e,t){for(var n,a,r,i=[t.x+t.vx,t.y+t.vy],o=function(e){return Math.hypot(e.x-i[0],e.y-i[1])},s=e.getTotalLength(),c=16,l=Number.POSITIVE_INFINITY,d=0;d<=s;d+=c){var h=e.getPointAtLength(d),m=o(h);m<l&&(n=h,a=d,l=m)}if(l>=2*t.radius&&l>=Math.hypot(t.vx,t.vy))return{distance:l};for(c/=2;c>.5;){var u=a-c,p=e.getPointAtLength(u),f=o(p),g=a+c,v=o(r=e.getPointAtLength(g));u>=0&&f<l?(n=p,a=u,l=f):g<=s&&v<l?(n=r,a=g,l=v):c/=2}return{distance:l,after:r,best:n}}(e,t);if(a.distance<=t.radius||a.distance<=Math.hypot(t.vx/2,t.vy/2)){var r=[a.after.y-a.best.y,a.best.x-a.after.x],i=Math.hypot.apply(Math,function(e){if(Array.isArray(e))return o(e)}(n=r)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(n)||function(e,t){if(e){if("string"==typeof e)return o(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?o(e,t):void 0}}(n)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}());r=r.map(function(e){return e/i});var s=[t.x-a.best.x,t.y-a.best.y];Math.acos((s[0]*r[0]+s[1]*r[1])/Math.hypot.apply(Math,s))>=Math.PI/2&&(r[0]=-r[0],r[1]=-r[1]);var c=t.vx*r[0]+t.vy*r[1];if(Math.acos(c/Math.hypot(t.vx,t.vy))<Math.PI/2)return;var l=Math.random()+1,d=[],h=0;do{d=[(l+=.05)*c*r[0],l*c*r[1]],h=Math.hypot(t.x+t.vx-d[0]-a.after.x,t.y+t.vy-d[1]-a.after.y)}while(Math.abs((t.vx-d[0])*r[0]+(t.vy-d[1])*r[1])<=Math.abs(c)&&h<t.radius&&l<3);if(l<2){var m=[-r[1],r[0]];Math.acos((t.vx*m[0]+t.vy*m[1])/Math.hypot(t.vx,t.vy))>Math.PI/2&&(m[0]*=-1,m[1]*=-1);var u=t.vx*m[0]+t.vy*m[1];for(l=.1;Math.hypot(t.vx-d[0],t.vy-d[1])<.6*Math.hypot(t.vx,t.vy)&&l<1;)l+=.1,d[0]-=.1*u*m[0],d[1]-=.1*u*m[1];for(;Math.hypot(t.vx-d[0],t.vy-d[1])>Math.hypot(t.vx,t.vy);)d[0]+=.05*u*m[0],d[1]+=.05*u*m[1]}t.vx-=d[0],t.vy-=d[1]}})})}return n.initialize=function(e){t=e},n}function c(e,t){if(e){if("string"==typeof e)return l(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?l(e,t):void 0}}function l(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=Array(t);n<t;n++)a[n]=e[n];return a}var d="http://www.w3.org/2000/svg";function h(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=d3.forceSimulation();Object.assign(this,{laps:10},n,{gradients:[],rails:[],tick:0,time:0,finalStanding:[]});var r=document.createElementNS(d,"g");r.setAttribute("id","gTrack");var o=document.createElementNS(d,"g");o.setAttribute("id","gCars"),e instanceof SVGElement&&(e.appendChild(r),e.appendChild(o)),Object.defineProperties(this,{simulation:{get:function(){return a}},svg:{get:function(){return e}},gTrack:{get:function(){return r}},gCars:{get:function(){return o}}}),Array.isArray(n.gradients)?this.setTrack(n.gradients.map(function(e){return new i(e)})):Array.isArray(n.trackPieces)&&this.setTrack(n.trackPieces.map(function(e){return new i(e)})),Array.isArray(t)&&this.setCars(t)}h.fromJson=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return t instanceof SVGElement||(t=document.querySelector("svg")),new h(t,e.cars,e)},Object.defineProperties(h.prototype,{init:{enumerable:!0,value:function(){var e=this;if(!(this.svg instanceof SVGElement))throw new Error("RaceTrack.init requires valid svg element!");return this.svg.getElementById("gTrack")||this.svg.appendChild(this.gTrack),this.svg.getElementById("gCars")||this.svg.appendChild(this.gCars),this.simulation.force("fCollide",d3.forceCollide(function(e){return e.radius})),this.simulation.force("fRailing",s(this.rails)),this.simulation.nodes().forEach(function(t,n){t.lapTimes=[],t.x=-7*(n+1),t.y=5*Math.pow(-1,n),t.vx=.9,t.vy=0,t.trackAhead=e.gradients.slice(),t.posn=[]}),this.moveCars(),this.listCars(),this.simulation.alphaDecay(0),this.simulation.velocityDecay(.01),this.simulation.on("tick",function(){e.onTick()}),this}},onTick:{value:function(){var e=this;if(this.simulation.nodes(this.simulation.nodes()),requestAnimationFrame(function(t){e.time=t}),this.tick++,this.moveCars(),this.listCars(),this.cars.every(function(t){return t.lapTimes.length>e.laps})){this.simulation.stop(),this.cars.forEach(function(e){delete e.sphere});var t=document.createElement("a");t.setAttribute("href","data:text/json;charset=utf-8,".concat(encodeURIComponent(JSON.stringify(this))));var n=new Date;return t.setAttribute("download","race-".concat(n.getFullYear(),"-").concat(n.getMonth()+1,"-").concat(n.getDate(),".json")),t.innerText="Save race data",document.querySelector("form").appendChild(t),void window.dispatchEvent(new CustomEvent("raceEnd",{detail:[this]}))}return this}},moveCars:{value:function(){var e=this;return d3.selectAll("#gCars circle").attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y}),this.simulation.nodes().forEach(function(t,n,a){if(t.nextPiece){var r=e.gradients.indexOf(t.trackAhead[0]);t.time.some(function(e){return e.lap===t.lapTimes.length&&e.piece===r})||(t.time.push({lap:t.lapTimes.length,piece:r,tick:e.tick,time:e.time}),0!==r)||(e.finalStanding.includes(t.name)||(t.time.slice(-1).pop(),t.lapTimes.push({tick:e.tick,time:e.time})),t.lapTimes.length>e.laps&&(e.finalStanding.includes(t.name)||e.finalStanding.push(t.name))),t.trackAhead.push(t.trackAhead.shift()),t.nextPiece=!1}if(t.previousPiece&&(t.trackAhead.unshift(t.trackAhead.pop()),t.previousPiece=!1),e.finalStanding.includes(t.name)){var i=e.finalStanding.indexOf(t.name);t.y=Math.min(Math.max(-20,t.y),20),t.x>e.gradients[0].x+10*(e.cars.length-i)&&(t.fx=t.x,t.fy=t.y)}(t.x<e.extrema[0][0]-10||t.x>e.extrema[0][1]+10||t.y<e.extrema[1][0]-10||t.y>e.extrema[1][1]+10)&&e.simulation.stop()}),this.cars.forEach(function(t){t.posn.push({tick:e.tick,time:e.time,vx:t.vx,vy:t.vy,x:t.x,y:t.y})}),this}},setTrack:{enumerable:!0,value:function(e){var t=this;this.gradients=e.filter(function(e){return e instanceof i});var n=[0,0],a=[[0,0],[0,0]],r=[[],[]];this.rails=new Array(2).fill({});var o=[];this.gTrack.innerHTML="",this.gradients.forEach(function(e,i){n[0]+=e.delta[0],n[1]+=e.delta[1],o.push([n[0],n[1]]),e.x=n[0],e.y=n[1],e.force&&t.simulation.force("piece".concat(i),e.force);var s,h=Math.acos(e.gradient[0]/Math.hypot.apply(Math,function(e){if(Array.isArray(e))return l(e)}(s=e.gradient)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(s)||c(s)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()));e.gradient[1]<0&&(h=2*Math.PI-h);var m={x1:n[0]+e.width*Math.sin(h),y1:n[1]-e.width*Math.cos(h),x2:n[0]-e.width*Math.sin(h),y2:n[1]+e.width*Math.cos(h)};e.m=(m.y2-m.y1)/(m.x2-m.x1),e.b=-e.m*m.x1+m.y1,e.rail.forEach(function(e,t,n){"number"==typeof e&&(n[t]=[e,e])});var u=document.createElementNS(d,"line");r[0].push({before:[m.x1-e.width*Math.cos(h)*e.rail[0][0],m.y1-e.width*Math.sin(h)*e.rail[0][0]],is:[m.x1,m.y1],after:[m.x1+e.width*Math.cos(h)*e.rail[0][1],m.y1+e.width*Math.sin(h)*e.rail[0][1]]}),r[1].push({before:[m.x2-e.width*Math.cos(h)*e.rail[1][0],m.y2-e.width*Math.sin(h)*e.rail[1][0]],is:[m.x2,m.y2],after:[m.x2+e.width*Math.cos(h)*e.rail[1][1],m.y2+e.width*Math.sin(h)*e.rail[1][1]]}),a[0][0]=Math.min(a[0][0],m.x1,m.x2),a[0][1]=Math.max(a[0][1],m.x1,m.x2),a[1][0]=Math.min(a[1][0],m.y1,m.y2),a[1][1]=Math.max(a[1][1],m.y1,m.y2),Object.entries(m).forEach(function(e){var t=function(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var a,r,i,o,s=[],c=!0,l=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(a=i.call(n)).done)&&(s.push(a.value),s.length!==t);c=!0);}catch(e){l=!0,r=e}finally{try{if(!c&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(l)throw r}}return s}}(e,t)||c(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}(e,2),n=t[0],a=t[1];u.setAttribute(n,a)}),u.classList.add("checkpoint"),0===i&&u.classList.add("start-line"),t.gTrack.appendChild(u),d3.select("svg #gTrack").append("circle").attr("cx",e.x).attr("cy",e.y).attr("r",0===i?1.5:2).attr("fill",e.color||"whitesmoke").attr("strokeWidth",0===i?"0.5px":"0").attr("stroke",0===i?"white":"none")}),this.extrema=a,r.forEach(function(e,n){e.push(e[0]);var a=document.createElementNS(d,"path"),r=[];e.forEach(function(t,n){0===n?r.push("M".concat(t.is.join(","))):r.push("C".concat([e[n-1].after.join(" "),t.before.join(" "),t.is.join(" ")].join(",")))}),a.setAttribute("d",r.join("")),t.gTrack.appendChild(a),t.rails[n]=a});var s=a[0][1]-a[0][0]+20,h=a[1][1]-a[1][0]+20,m=a[0][0]-10,u=a[1][0]-10;return h>4*s/5?(s=5*h/4,m=(a[0][0]+a[0][1]-s)/2):(h=4*s/5,u=(a[1][0]+a[1][1]-h)/2),this.svg.setAttribute("viewBox","".concat(m," ").concat(u," ").concat(s," ").concat(h)),d3.select("svg").append("g").selectAll("path").data([o]).enter().append("path").attr("d",d3.line().curve(d3.curveBasisClosed)).classed("lane-line",!0),this}},setCars:{enumerable:!0,value:function(e){return d3.select("svg #gCars").selectAll("circle").data(e).enter().append("circle").classed("car",!0).attr("fill",function(e){return e.color}).attr("stroke",function(e){return e.color2}).attr("stroke-width",function(e){return e.strokeWidth}).attr("r",function(e){return e.r}).attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y}),this.simulation.nodes(e),this.cars=e.slice(),this}},listCars:{enumerable:!0,value:function(){var e=this,t=[],n=document.querySelector("output#lapCount"),a=document.querySelector("ol#positions");return this.cars.slice().sort(function(e,t){return 0===e.time.length&&0===t.time.length?0:0===e.time.length?1:0===t.time.length||e.time.length>t.time.length?-1:e.time.length<t.time.length||e.time[e.time.length-1].time>t.time[t.time.length-1].time?1:e.time[e.time.length-1].time<t.time[t.time.length-1].time?-1:0}).forEach(function(r,i){if(!(r.elPositionList instanceof Element)){r.elPositionList=document.createElement("li");var o=document.createElement("span");o.classList.add("name"),o.innerText=r.name,r.elPositionList.appendChild(o);var s=document.createElement("span");s.classList.add("time"),r.elPositionList.appendChild(s)}var c=r.elPositionList;if(r.time.length>1){var l=r.time.slice().pop();0===i&&(t=r.time.slice(),n.innerHTML="Lap ".concat(r.lapTimes.length," of ").concat(e.laps));var d=c.querySelector(".time");if(0===i){var h=((l.time-r.time[0].time)/1e3).toFixed(2);d.innerText!==h&&(d.innerText=h),d.classList.remove("fade-out")}else{var m=t.filter(function(e){return e.lap===l.lap&&e.piece===l.piece}).sort(function(e,t){return e.time-t.time})[0];l||console.error("lastTime:",l),m||console.error("leadTime:",m);var u=(l.time-m.time)/1e3;u=u>0?"+".concat(u.toFixed(2)):u.toFixed(2),d.innerText!==u&&(d.classList.remove("fade-out"),r.lapTimes.length<e.laps&&setTimeout(function(){d.classList.add("fade-out")},1e3),d.innerText=u)}}c.style.order=i,c.setAttribute("order",i+1),a.contains(c)||a.appendChild(c)}),this}}});const m=h;function u(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Object.assign(this,{strokeWidth:1,r:4},n,{trackAhead:[],nextPiece:!1,previousPiece:!1,lapTimes:[],time:[],posn:[]}),Object.defineProperties(this,{name:{enumerable:!0,get:function(){return e}},radius:{enumerable:!0,get:function(){return t.r+t.strokeWidth/2}}})}Object.defineProperties(u.prototype,{}),window.json={},json.cSuzuka=e,json.cOval=t,yodasws.page("home").setRoute({template:"pages/home.html",route:"/"}).on("load",()=>{const e=document.querySelector("svg#scene");document.getElementById("btnTick").remove();const t=document.createElement("button");t.innerText="Flag!",t.addEventListener("click",e=>{e.preventDefault(),console.error("Sam, flag!")}),document.querySelector("form").appendChild(t);let n=new m(e,[new u("Alice, TX",{color:"lightgreen",color2:"orange",rgb:[144,238,144]}),new u("Brooklyn, NY",{color:"white",color2:"black",r:3,strokeWidth:3,rgb:[68,68,68]}),new u("Charlotte, NC",{color:"#249E57",color2:"lightgrey",r:3.5,strokeWidth:2,rgb:[36,158,87]}),new u("Dallas, TX",{color:"red",color2:"#000191",r:3.5,strokeWidth:2,rgb:[0,1,145]}),new u("Edison, NJ",{color:"white",color2:"#00375D",r:3,strokeWidth:3,rgb:[48,103,141]}),new u("Florence, TN",{color:"#1E3258",color2:"#BF1F2D",r:3.5,strokeWidth:2,rgb:[191,31,45]}),new u("Garland, TX",{color:"#E61234",color2:"#FDB920",r:3,strokeWidth:3,rgb:[253,185,32]}),new u("Helena, AL",{color:"white",color2:"#A49C44",r:3,strokeWidth:3,rgb:[180,156,38]})].sort(()=>0),Object.assign({},json.cSuzuka,{laps:10}));n.simulation.stop(),n.init(),v(n),document.getElementById("btnStart").focus(),document.getElementById("btnStart").addEventListener("click",e=>{switch(e.preventDefault(),e.currentTarget.innerText){case"Start":console.log("Sam, start!"),n.simulation.stop(),n.init(),n.simulation.alpha(1),setTimeout(e=>{n.simulation.restart(),e.innerText="Pause",e.disabled=!1,e.focus()},500,e.currentTarget),e.currentTarget.disabled=!0,clearInterval(g);break;case"Pause":n.simulation.stop(),e.currentTarget.innerText="Play";break;case"Play":n.simulation.restart(),e.currentTarget.innerText="Pause"}}),document.getElementById("btnTick")instanceof Element&&document.getElementById("btnTick").addEventListener("click",e=>{e.preventDefault(),n.simulation.tick(),n.onTick()}),document.querySelector("input[type=\"file\"]").addEventListener("change",t=>{const a=t.target.files[0];if("application/json"!==a.type)return void t.preventDefault();const r=new FileReader;r.onload=t=>{const a=JSON.parse(t.target.result);n=m.fromJson(a,e),n.simulation.stop(),v(n);const r=document.querySelector("form #btnExport");r instanceof HTMLElement&&r.removeAttribute("disabled")},r.readAsText(a)})});const p=(()=>{const e=new EventTarget,t=new Set;let n;return e.addφListener=(n,a)=>{t.add(n),e.addEventListener("\u03C6Change",e=>{e.detail.φ===n&&a(e)})},e.φChange=(a,r)=>{t.forEach(t=>{n<=t&&t<a&&e.dispatchEvent(new CustomEvent("\u03C6Change",{detail:{φ:t}}))}),n=a},e})(),f=(()=>{const e={setφToActivateCamera:{value(e){p.addφListener(e,e=>{scene.activeCamera=this})}}};return new Proxy(function(e="",t=[],{φRange:n=[-Math.PI/2,3*Math.PI/2]}={}){this.φRange=n,this.uuid=Math.floor(1e3*Math.random()).toString().padStart(3,"0")},{construct(t,n){const[a,r]=n,i=BABYLON[a];if(!i)throw new TypeError(`Unknown camera type '${a}'`);if(!(i.prototype instanceof BABYLON.TargetCamera))throw new TypeError(`Invalid camera type '${a}'`);const o=Object.create(i.prototype);return i.apply(o,r),t.apply(o,n),Object.defineProperties(o.__proto__,e),o}})})();let g;function v(e,{OverheadCirclingSpeed:t=5,filmCountdownOnly:n=!1,doExport:a=!1,targetFrameRate:r=30,renderFrameRate:i=30}={}){clearInterval(g);const{AbstractMesh:o,Animation:s,AnimationGroup:c,Color3:l,Color4:d,DirectionalLight:h,Engine:m,FollowCamera:u,Mesh:y,MeshBuilder:w,Scene:T,SkyMaterial:x,StandardMaterial:b,Texture:E,UniversalCamera:A,Vector3:C,GUI:M,GrassProceduralTexture:I,DynamicTerrain:S}=BABYLON,k=document.querySelector("canvas#replay"),P=new m(k,!0),L=new T(P);L.useRightHandedSystem=!0,L.ambientColor=new l(.8,.8,.8);const O={cross:Math.max(Math.abs(e.extrema[0][1]-e.extrema[0][0]),Math.abs(e.extrema[1][1]-e.extrema[1][0])),height:e.extrema[1][1]-e.extrema[1][0],width:e.extrema[0][1]-e.extrema[0][0],midpoint:new C((e.extrema[0][0]+e.extrema[0][1])/2,0,(e.extrema[1][0]+e.extrema[1][1])/2)};Object.entries({sPosition:{get(){const e=[this.position.x-O.midpoint.x,this.position.y-O.midpoint.y,this.position.z-O.midpoint.z],t=Math.hypot(...e);return{r:t,φ:0===e[0]?0:Math.atan(e[2]/e[0])+(e[0]<0?Math.PI:0),θ:0===e[1]?0:Math.acos(Math.hypot(e[0]/t,e[2]/t)/e[1]/t)}},set(...e){const[t,n,a]=Array.isArray(e[0])?e[0]:e;this.position=new C(t*Math.sin(a)*Math.cos(n)+O.midpoint.x,t*Math.sin(a)*Math.sin(n)+O.midpoint.z,t*Math.cos(a)+O.midpoint.y)}}}).forEach(([e,t])=>{[BABYLON.TransformNode.prototype,BABYLON.Camera.prototype].forEach(n=>{n.hasOwnProperty(e)||Object.defineProperty(n,e,t)})});const N=new x("sky",L);N.backFaceCulling=!1,N.luminance=.2,N.useSunPosition=!0,N.sunPosition=new C(10,3,1),N.turbidity=2,N.rayleigh=3,N.cameraOffset.y=200;const R=y.CreateSphere("skyBox",5,2*O.cross,L);R.material=N,R.position=O.midpoint;const _=new h("light2",N.sunPosition.negate(),L);_.diffuse=new l(1,1,1),_.intensity=.5;const j=[new f("UniversalCamera",["cameraTopLeftCorner",new C(e.extrema[0][0],20,e.extrema[1][0]-30),L],{φRange:[150*Math.PI/180,5*Math.PI/4]}),new f("UniversalCamera",["cameraOverheadCenter",new C(-35,160,2*e.extrema[1][1]),L]),new f("UniversalCamera",["cameraTopRightCorner",new C(e.extrema[0][1]+10,20,e.extrema[1][0]-10),L],{φRange:[-Math.PI/2,10*Math.PI/180]}),new f("UniversalCamera",["cameraBackMidfield",new C(-50,50,e.extrema[1][1]+70),L],{φRange:[0*Math.PI/180,125*Math.PI/180]}),new f("UniversalCamera",["cameraCircling",new C(e.extrema[0][0]+200,20,e.extrema[1][0]-10),L])];j.find(e=>"cameraTopRightCorner"===e.id).setφToActivateCamera(0);const F=new b("grass",L);F.ambientColor=new l(127/255,229/255,112/255),F.ambientTexture=new I("grassPT",256,L),F.specularColor=new l(80/255,80/255,80/255);const G=new b("asphalt",L);G.ambientColor=new l(183/255,181/255,186/255),G.specularColor=new l(96/255,96/255,96/255);const B=new I("asphaltPT",256,L);B.grassColors=[new l(183/255,181/255,186/255),new l(135/255,133/255,138/255),new l(151/255,149/255,154/255)],G.ambientTexture=B;const z=new b("black",L);z.diffuseColor=new l(1/255,1/255,1/255),z.ambientColor=new l(1/255,1/255,1/255);const D=new b("trackSiding",L);D.diffuseColor=new l(235/255,88/255,99/255),D.ambientColor=new l(235/255,88/255,99/255),D.specularColor=new l(160/255,160/255,160/255);const V=(()=>{const e=200,t=new Float32Array(12e4);for(let n=0;n<200;n++)for(let a=0;a<e;a++){const r=[5*(a-100),-.05,5*(n-100)];t[3*(n*e+a)+0]=r[0],t[3*(n*e+a)+1]=r[1],t[3*(n*e+a)+2]=r[2]}const n=new S("dtGround",{mapData:t,mapSubX:e,mapSubZ:200,terrainSub:60},L);return n.updateCameraLOD=e=>Math.abs(e.globalPosition.y/10|0),n.mesh.material=F,n.isAlwaysVisible=!0,n})();((e={})=>{const{trackEdge:t=-20,sideHeight:n=2,front:a=-50,back:r=-150,left:i=-100,right:o=100,height:s=50}=e,c=w.CreateRibbon("stands",{closePath:!1,pathArray:[[new C(o,-.03,t),new C(o,-.03,a),new C(o,s,r)],[new C(i,-.03,t),new C(i,-.03,a),new C(i,s,r)]]},L),d=new b("crowd",L);d.ambientColor=new l(170/255,170/255,170/255),d.specularColor=new l(64/255,64/255,64/255);const h=new I("crowdPT",256,L);h.grassColors=[new l(165/255,165/255,215/255),new l(215/255,165/255,170/255),new l(165/255,215/255,165/255)],d.ambientTexture=h,c.material=d;const m=w.CreateRibbon("standsSides",{sideOrientation:y.DOUBLESIDE,closePath:!1,pathArray:[[new C(o,-.03,t),new C(o,-.03,a),new C(o,-.03,r),new C(o,-.03,r),new C(i,-.03,r),new C(i,-.03,r),new C(i,-.03,a),new C(i,-.03,t)],[new C(o,-.03+n,t),new C(o,-.03+n,a),new C(o,s+n,r),new C(o,s+n,r),new C(i,s+n,r),new C(i,s+n,r),new C(i,-.03+n,a),new C(i,-.03+n,t)]]},L),u=new b("standsSiding",L);u.diffuseColor=new l(99/255,99/255,99/255),u.ambientColor=new l(131/255,131/255,131/255),u.specularColor=new l(208/255,208/255,208/255),m.material=u})(e.grandStand),(()=>{const n=[],a=new s("spinningCamera","position",i,s.ANIMATIONTYPE_VECTOR3,s.ANIMATIONLOOPMODE_CYCLE),[r,o]=O.height<O.width?[.7*O.width,1*O.height]:[O.width*(.5+1/6),O.height*(.5+1/6)];for(let e=0;e<360;e++)n.push({frame:Math.floor(e*t),value:new C(Math.cos((180+e)*Math.PI/180)*r+O.midpoint.x,100,Math.sin((180+e)*Math.PI/180)*o+O.midpoint.z)});a.setKeys(n);const l=new c("animeFlyover");l.normalize(0,n[n.length-1].frame);const d=e.cars.slice(0,3),h=new C(d.reduce((e,t)=>e+t.posn[0].x,0)/d.length,d.reduce((e,t)=>e+t.radius,0)/d.length,d.reduce((e,t)=>e+t.posn[0].y,0)/d.length);j.filter(e=>"cameraCircling"===e.id).forEach(e=>{e.lockedTarget=h,l.addTargetedAnimation(a,e)}),l.play(!0)})();const H=[[],[]],U=[[],[]];e.rails.forEach((e,t)=>{const n=e.getTotalLength();for(let a=0;a<100;a+=.2){const r=e.getPointAtLength(n*a/100);H[t].push(new C(r.x,0,r.y)),U[t].push(new C(r.x,5,r.y))}}),U.forEach((e,t)=>{const n=[e,H[t]];w.CreateRibbon(`rail${t}`,{sideOrientation:y.DOUBLESIDE,pathArray:n,closePath:!0},L).material=D}),w.CreateRibbon("track",{pathArray:H.reverse(),closePath:!0},L).material=G;const $=e.gradients[0];w.CreateLines("startLine",{points:[new C($.x-$.width*Math.sin($.α),.02,$.y+$.width*Math.cos($.α)),new C($.x+$.width*Math.sin($.α),.02,$.y-$.width*Math.cos($.α))],colors:new Array(2).fill(new d(0,0,0,1)),useVertexAlpha:!1},L).material=z;const q=e.cars.slice();q.forEach(e=>{const t=e.posn[0];if(e.sphere=w.CreateSphere(`sphere${e.name}`,{segments:16,diameter:2*e.radius},L),e.sphere.position=new C(t.x,e.radius,t.y),Array.isArray(e.rgb)){const t=new b(`${e.name}Material`,L);t.diffuseColor=new l(...e.rgb.map(e=>e/255)),t.ambientColor=new l(...e.rgb.map(e=>e/255)),t.diffuseTexture=new E("ball.png",L),e.sphere.material=t}});let W=7;const Y=a?s.ANIMATIONLOOPMODE_CONSTANT:s.ANIMATIONLOOPMODE_CYCLE;let Z;const J={flyover:{playTime:n?1:20,nextStage:"countdown",loopAnimes:!0,camera:j.find(e=>"cameraCircling"===e.id),cameras:j},countdown:{animes:new c("animeCountdown"),camera:j.find(e=>"cameraOverheadCenter"===e.id),nextStage:"race",playTime:3.5},race:{animes:new c("animeRace"),secondsToSwitchCameras:5,rotateCamera:!0,cameras:j,nextStage:"afterRace"},afterRace:{secondsToSwitchCameras:2.5,rotateCamera:!0,playTime:20,cameras:j}};J.events=new EventTarget,J.events.addEventListener("start",function(e){Z=e.detail;const t=J[Z];if(!t)throw Error(`Could not find stage ${Z}`);"string"==typeof t.camera?L.activeCamera=j.find(e=>e.id===t.camera):t.camera instanceof BABYLON.TargetCamera&&(L.activeCamera=t.camera),"function"==typeof t.onStartStage&&t.onStartStage(),t.animes instanceof c&&t.animes.play(!!t.loopAnimes),Number.isFinite(t.playTime)&&t.playTime>0&&setTimeout(()=>{this.dispatchEvent(new CustomEvent("end",{detail:Z}))},1e3*t.playTime*r/i)}),J.events.addEventListener("end",function(e){const t=e.detail;if(J[t]){const e=J[t];"function"==typeof e.onEndStage&&e.onEndStage(),e.nextStage&&J[e.nextStage]&&this.dispatchEvent(new CustomEvent("start",{detail:e.nextStage})),e.overlay&&e.overlay.autoDispose&&e.overlay.dispose()}}),J.flyover,(e=>{const{AdvancedDynamicTexture:t,Control:n,Rectangle:a,TextBlock:o}=M,s=new t.CreateFullscreenUI("myUI");s.useInvalidateRectOptimization=!1,s.renderScale=2,e.overlay=s;const c=new a;c.horizontalAlignment=n.HORIZONTAL_ALIGNMENT_CENTER,c.verticalAlignment=n.VERTICAL_ALIGNMENT_CENTER,c.background="white",c.height="0.1",c.width="0.25",c.paddingLeft="20%",c.clipChildren=!1,c.clipContent=!1,c.cornerRadius=100;const l=new o;l.fontSize=100,l.fontWeight="bold",l.color="black",l.textHorizontalAlignment=n.HORIZONTAL_ALIGNMENT_CENTER,l.textVerticalAlignment=n.VERTICAL_ALIGNMENT_CENTER,l.horizontalAlignment=n.HORIZONTAL_ALIGNMENT_CENTER,l.verticalAlignment=n.VERTICAL_ALIGNMENT_CENTER,c.addControl(l);let d,h=3;const m=()=>{3===h&&s.addControl(c),l.text=h>0?h.toString():"Go!",h--};e.onStartStage=()=>{setTimeout(()=>{m(),d=setInterval(m,1e3*r/i)},500*r/i)},e.onEndStage=()=>{d&&(m(),clearInterval(d)),setTimeout(()=>{s.removeControl(c),s.dispose()},1e3*r/i)}})(J.countdown);const X=(e,t)=>t.tick-e.tick,K=(e=>{let t=[];const n=()=>{t=e.map(e=>({name:e.name,radius:e.radius,lenTime:e.time.length,time:e.time.slice().sort(X),posn:e.posn.slice().sort(X)}))};n();const a=e=>(t.forEach(t=>{t.curTime=t.time.find(t=>t.tick<=e),t.curPosn=t.posn.find(t=>t.tick<=e)}),t.sort((e,t)=>{if(0===e.lenTime&&0===t.lenTime)return 0;if(0===e.lenTime)return 1;if(0===t.lenTime)return-1;if(void 0===e.curTime&&void 0===t.curTime)return 0;if(void 0===e.curTime)return 1;if(void 0===t.curTime)return-1;if(e.curTime.lap<t.curTime.lap)return 1;if(e.curTime.lap>t.curTime.lap)return-1;if(e.curTime.piece!==t.curTime.piece){if(0===e.curTime.piece)return-1;if(0===t.curTime.piece)return 1;if(e.curTime.piece<t.curTime.piece)return 1;if(e.curTime.piece>t.curTime.piece)return-1}return e.curTime.tick<t.curTime.tick?-1:e.curTime.tick>t.curTime.tick?1:0}),t);return a.reset=n,a})(q);let Q;if(q[0].posn.length>1){let t=0;const n=2*Math.PI;if(q.forEach(e=>{let a=0,r=0;const o=[],c=[new s(`moveAnime${e.name}`,"position",i,s.ANIMATIONTYPE_VECTOR3,Y),new s(`spinAnime${e.name}`,"rotation",i,s.ANIMATIONTYPE_VECTOR3,Y)];c.forEach(e=>o.push([])),e.posn.forEach(i=>{const s=3*i.tick;o[0].push({frame:s,value:new C(i.x,e.radius,i.y)});const c=Math.hypot(i.vx,i.vy);if(c>0){let e=-Math.sign(i.vy)*Math.acos(i.vx/c)%n-r%n;for(;Math.abs(e)>Math.PI;)e-=Math.sign(e)*n;r+=e,a-=c*Math.PI/16}o[1].push({frame:s,value:new C(0,r,a)}),t=Math.max(t,i.tick)}),W=o.reduce((e,t)=>Math.max(e,t[t.length-1].frame),W),c.forEach((t,n)=>{t.setKeys(o[n]),J.race.animes.addTargetedAnimation(t,e.sphere)})}),!(document.querySelector("form #btnExport")instanceof HTMLElement)){const t=document.createElement("button");t.setAttribute("id","btnExport"),t.innerText="Export",t.addEventListener("click",()=>{t.setAttribute("disabled","disabled"),clearInterval(g),v(e,{OverheadCirclingSpeed:4,doExport:!0,targetFrameRate:60,renderFrameRate:2})});const n=document.querySelector("form");n instanceof Element&&n.appendChild(t)}(()=>{const e=[],n=[new s("cameraTrack","position",i,s.ANIMATIONTYPE_VECTOR3,Y)];n.forEach(t=>e.push([]));for(let n=0;n<t;n++){const t=K(n).slice(0,3),a=[t.reduce((e,t)=>e+t.curPosn.x,0)/t.length,t.reduce((e,t)=>e+t.radius,0)/t.length,t.reduce((e,t)=>e+t.curPosn.y,0)/t.length];e[0].push({frame:3*n,value:new C(...a),φ:0===a[0]?0:Math.atan(a[2]/a[0])})}K.reset(),W=e.reduce((e,t)=>Math.max(e,t[t.length-1].frame),W),Q=new o("raceCameraTarget",L),Q.position=e[0][0].value,J.race.cameras.forEach(e=>e.lockedTarget=Q),j.filter(e=>"cameraCircling"===e.id).forEach(e=>{e.lockedTarget=Q}),n.forEach((t,n)=>{t.setKeys(e[n]),J.race.animes.addTargetedAnimation(t,Q)})})(),J.race.animes.normalize(0,W)}else delete J.flyover.nextStage,J.flyover.cameras.forEach(e=>e.setTarget(new C(0,4.5,0)));const ee=(()=>{const{AdvancedDynamicTexture:t,Control:n,StackPanel:a,TextBlock:r,XmlLoader:i}=M,o=new t.CreateFullscreenUI("myUI");o.useInvalidateRectOptimization=!1,o.renderScale=2,J.race.overlay=o,J.race.overlay.autoDispose=!0;const s=new a;s.horizontalAlignment=n.HORIZONTAL_ALIGNMENT_LEFT,s.verticalAlignment=n.VERTICAL_ALIGNMENT_TOP,s.background="white",s.width="0.14",s.top="0",s.left="0",s.clipChildren=!1,s.clipContent=!1,J.events.addEventListener("start",function(e){"flyover"===e.detail&&o.addControl(s)});const c=new a;c.horizontalAlignment=n.HORIZONTAL_ALIGNMENT_LEFT,c.verticalAlignment=n.VERTICAL_ALIGNMENT_BOTTOM,c.background="white",c.width="0.1",c.clipChildren=!1,c.clipContent=!1;const l=new r;l.fontSize=70,l.height="110px",l.color="black",l.paddingLeft="20px",l.paddingBottom="20px",l.paddingTop="20px",l.textHorizontalAlignment=n.HORIZONTAL_ALIGNMENT_LEFT,l.textVerticalAlignment=n.VERTICAL_ALIGNMENT_BOTTOM,c.addControl(l);const d=new Array(q.length).fill(0).map((e,t)=>{const a=new r;return a.fontSize=70,a.color="black",a.paddingLeft="10px",a.height="90px",0===t&&(a.paddingTop="20px",a.height="110px"),a.textHorizontalAlignment=n.HORIZONTAL_ALIGNMENT_LEFT,a.textVerticalAlignment=n.VERTICAL_ALIGNMENT_TOP,s.addControl(a),a});return function(t){K(t).forEach((t,n)=>{0===n&&t.curTime&&(o.addControl(c),t.curTime.lap>e.laps?l.text="Finish!":t.curTime.lap>0?l.text=`Lap ${t.curTime.lap} / ${e.laps}`:l.text="GO!"),d[n].text=`${n+1} ${t.name}`})}})();(e=>{const{AdvancedDynamicTexture:t,Control:n,StackPanel:a,TextBlock:r}=M,i=J[e],o=new t.CreateFullscreenUI("myUI");o.useInvalidateRectOptimization=!1,o.renderScale=2,i.overlay=o;const s=new a;s.horizontalAlignment=n.HORIZONTAL_ALIGNMENT_RIGHT,s.verticalAlignment=n.VERTICAL_ALIGNMENT_CENTER,s.background="white",s.width="0.31",s.clipChildren=!1,s.clipContent=!1;const c=new Array(q.length).fill(0).map((e,t)=>{const a=new r;return a.fontSize=150,a.color="black",a.paddingLeft="10px",a.height=`${a.fontSize+30}px`,a.textHorizontalAlignment=n.HORIZONTAL_ALIGNMENT_LEFT,a.textVerticalAlignment=n.VERTICAL_ALIGNMENT_TOP,s.addControl(a),a});J.events.addEventListener("start",function(t){t.detail===e&&o.addControl(s)}),i.overlay.render=()=>{const e=q.reduce((e,t)=>Math.max(e,t.lapTimes[t.lapTimes.length-1].tick),0);K(e).forEach((e,t)=>{c[t].text=`${t+1} ${e.name}`})}})("afterRace"),L.activeCamera=j[0];const te=(()=>{let e=1;return J.race.animes.onAnimationGroupPlayObservable.add(()=>{e=0}),J.race.animes.onAnimationGroupEndObservable.add(()=>{e=0}),{pickNextCamera:function(){if(!0===J[Z].rotateCamera&&ae%J[Z].framesToSwitchCameras===0){if(Q instanceof o){const t=e;L.activeCamera;do{if(e++,j[e%j.length].φRange[0]<=Q.sPosition.φ&&Q.sPosition.φ<j[e%j.length].φRange[1])break}while(e%j.length!==t%j.length)}else e++;!function(t){if(!Number.isInteger(t)||t<0)throw new TypeError("newActiveCameraIndex must be a nonnegative integer");e=t,L.activeCamera=j[t%j.length]}(e),e%j.length==0&&re++}}}})(),ne=(e=>e?new WebMWriter({quality:.95,frameRate:r}):{addFrame(){},complete:()=>Promise.reject()})(a);let ae=0,re=0;Object.entries(J).forEach(([e,t])=>{Number.isFinite(t.secondsToSwitchCameras)&&(J[e].framesToSwitchCameras=t.secondsToSwitchCameras*r)}),L.beforeRender=e=>{V.camera!==e.activeCamera&&(V.camera=e.activeCamera,V.camera.position.y<30&&(V.initialLOD=5))},L.afterRender=e=>{a&&("flyover"!==Z||ae>5)&&ne.addFrame(k)},console.log("Sam, max number of frames:",W),Object.entries(J).forEach(([e,t])=>{t.animes instanceof c&&("function"==typeof t.onStartAnimation&&t.animes.onAnimationGroupPlayObservable.add(t.onStartAnimation),t.animes.onAnimationGroupEndObservable.add(()=>{J.events.dispatchEvent(new CustomEvent("end",{detail:e}))}))}),J.race.animes.onAnimationGroupPlayObservable.add(()=>{Z="race",ae=0,re=0}),J.race.animes.onAnimationGroupEndObservable.add(()=>{Z="afterRace",ae=0,re=0,W=J.afterRace.playTime*r,J.events.dispatchEvent(new CustomEvent("end",{detail:"race"}))}),g=setInterval(()=>{L.render(),["flyover","countdown"].includes(Z)&&ee(0),J.race.animes.isPlaying&&ee(ae/3),J[Z].overlay&&"function"==typeof J[Z].overlay.render&&J[Z].overlay.render(ae/3),te.pickNextCamera(),Q instanceof o&&p.φChange(Q.sPosition.φ),ae++,ae%20==0&&a&&console.log("Sam, frame",ae,",",(ae/r).toFixed(3),"seconds");let e=!1;n&&"race"===Z&&ae>=1*r&&(e=!0),"afterRace"===Z&&ae>=J.afterRace.playTime*r&&(e=!0),e&&(console.log("Sam, at end of video!"),a||n?(clearInterval(g),console.log("Sam, done running WebGL animation"),ne.complete().then(e=>{const t=URL.createObjectURL(e),n=document.querySelector("main");if(n instanceof Element){const e=document.createElement("a");e.innerText="Open  in new window",e.setAttribute("target","_blank"),e.setAttribute("href",t),n.appendChild(e);const a=document.createElement("video"),r=document.createElement("source");r.setAttribute("type","video/webm"),r.setAttribute("src",t),a.appendChild(r),n.appendChild(a)}else window.open(t,"_blank")}).catch(e=>{console.error("Sam, videoWriter failed:",e)})):(K.reset(),J.race.animes.play(!1)))},1e3/i),P.resize(),window.addEventListener("resize",()=>{P.resize()}),Z||J.events.dispatchEvent(new CustomEvent("start",{detail:"flyover"}))}window.addEventListener("raceEnd",e=>{Array.isArray(e.detail)&&e.detail[0]instanceof m&&v(...e.detail)})})();