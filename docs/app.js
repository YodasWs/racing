"use strict";function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_unsupportedIterableToArray(arr,i)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(arr,i){if(typeof Symbol==="undefined"||!(Symbol.iterator in Object(arr)))return;var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i["return"]!=null)_i["return"]()}finally{if(_d)throw _e}}return _arr}function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_unsupportedIterableToArray(arr)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(n);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}function _iterableToArray(iter){if(typeof Symbol!=="undefined"&&Symbol.iterator in Object(iter))return Array.from(iter)}function _arrayWithoutHoles(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr)}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i]}return arr2}function _typeof(obj){"@babel/helpers - typeof";if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof=function _typeof(obj){return typeof obj}}else{_typeof=function _typeof(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj}}return _typeof(obj)}!function(t){var e={};function i(a){if(e[a])return e[a].exports;var r=e[a]={i:a,l:!1,exports:{}};return t[a].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=t,i.c=e,i.d=function(t,e,a){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:a})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==_typeof(t)&&t&&t.__esModule)return t;var a=Object.create(null);if(i.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t){i.d(a,r,function(e){return t[e]}.bind(null,r))}return a},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){t.exports=i(1)},function(t,e){var i="http://www.w3.org/2000/svg";yodasws.page("home").setRoute({template:"pages/home.html",route:"/"}).on("load",function(){var t=new r(document.querySelector("svg#scene"),[{gradient:[1,0],delta:[0,0],width:20,color:"black",rail:[.5,1]},{gradient:[0,1],delta:[40,40],width:20,rail:[4,4]},{gradient:[1,1],delta:[13,27],width:20,rail:[4,1]},{gradient:[1,0],delta:[27,13],width:20,rail:[4,2]},{gradient:[0,1],delta:[40,40],width:20,rail:[.5,4]},{gradient:[-1,0],delta:[-70,40],width:20,rail:[.5,.5],color:"lightgreen"},{gradient:[-1,0],delta:[-150,0],width:20,rail:[.5,1]},{gradient:[0,-1],delta:[-50,-50],width:20,rail:[.5,1]},{gradient:[1,-100],delta:[0,-60],width:20,rail:[1,2]},{gradient:[1,-1],delta:[20,-40],width:20,rail:[1,4]},{gradient:[1,0],delta:[30,-10],width:20,rail:[1,4]}].map(function(t){return new a(t)}),[new s("Alice",{color:"lightgreen",color2:"orange"}),new s("Brooklyn",{color:"white",color2:"black",r:3,strokeWidth:3}),new s("Charlotte",{color:"#249E57",color2:"lightgrey",r:3.5,strokeWidth:2}),new s("Dallas",{color:"white",color2:"blue",r:3,strokeWidth:3}),new s("Edison",{color:"lightblue",color2:"cornflowerblue",r:3.5,strokeWidth:2}),new s("Florence",{color:"#1E3258",color2:"#BF1F2D",r:3.5,strokeWidth:2})],{laps:2});t.simulation.stop(),t.init(),document.getElementById("btnStart").addEventListener("click",function(){console.log("Sam, start!"),t.simulation.stop(),t.init(),t.simulation.alpha(1),setTimeout(function(){t.simulation.restart()},500)}),document.getElementById("btnPause").addEventListener("click",function(e){switch(e.currentTarget.innerText){case"Pause":t.simulation.stop(),e.currentTarget.innerText="Play";break;case"Play":t.simulation.restart(),e.currentTarget.innerText="Pause";}}),document.getElementById("btnTick").addEventListener("click",function(e){t.simulation.tick(),t.onTick()})});function a(t){var _this=this;Object.assign(this,{gradient:[1,0],delta:[0,0],width:20,rail:[2,2]},t);var e=Math.hypot.apply(Math,_toConsumableArray(this.gradient));var i=Math.acos(this.gradient[0]/e);-1===Math.sign(this.gradient[1])&&(i=2*Math.PI-i),this.α=i,this.force=function(){var t=[];var e=_this;function i(i){t.forEach(function(t){if(0===t.trackAhead.length)return;if(t.trackAhead[0]!==e)return;var a=[e.gradient[0]-t.vx,e.gradient[1]-t.vy],r=Math.hypot.apply(Math,_toConsumableArray(a));a=a.map(function(t){return t/r}),0!==Math.hypot(t.vx,t.vy)&&Math.acos((a[0]*t.vx+a[1]*t.vy)/Math.hypot.apply(Math,_toConsumableArray(a))/Math.hypot(t.vx,t.vy))>Math.PI/2&&(a=[0,0]),a=a.map(function(t,i){return t+e.gradient[i]}),r=Math.hypot.apply(Math,_toConsumableArray(a)),a=a.map(function(t){return t/r}),t.vx+=.1*a[0]*i,t.vy+=.1*a[1]*i;var s=[t.x+t.vx,t.y+t.vy];if(Number.isFinite(e.m)&&Number.isFinite(e.b)&&0!==e.α&&e.α!==Math.PI&&e.α!==2*Math.PI){var _i=e.m*s[0]+e.b;e.α>0&&e.α<Math.PI&&_i<=s[1]&&(t.nextPiece=!0),e.α>Math.PI&&_i>=s[1]&&(t.nextPiece=!0)}else 0===e.α&&e.x<s[0]&&(t.nextPiece=!0),e.α===Math.PI&&e.x>s[0]&&(t.nextPiece=!0);var n=t.trackAhead.slice(-1).pop();if(Number.isFinite(n.m)&&Number.isFinite(n.b)&&0!==n.α&&n.α!==Math.PI&&n.α!==2*Math.PI){var _e=n.m*t.x+n.b;n.α>0&&n.α<Math.PI&&_e>t.y&&(t.previousPiece=!0),n.α>Math.PI&&_e<t.y&&(t.previousPiece=!0)}else 0===n.α&&n.x>t.x&&(t.previousPiece=!0),n.α===Math.PI&&n.x<t.x&&(t.previousPiece=!0);t.previousPiece&&(t.nextPiece=!1)})}return i.initialize=function(e){t=e},i}()}function r(t,e,a,r){var s=d3.forceSimulation();Object.assign(this,{laps:10},r,{gradients:[],rails:[],time:0});var n=document.createElementNS(i,"g");n.setAttribute("id","gTrack");var o=document.createElementNS(i,"g");o.setAttribute("id","gCars"),t instanceof SVGElement&&(t.appendChild(n),t.appendChild(o)),Object.defineProperties(this,{simulation:{get:function get(){return s}},svg:{get:function get(){return t}},gTrack:{get:function get(){return n}},gCars:{get:function get(){return o}}}),e instanceof Array&&this.setTrack(e),a instanceof Array&&this.setCars(a)}function s(t,e){var _this2=this;Object.assign(this,{strokeWidth:1,r:4},e,{trackAhead:[],nextPiece:!1,previousPiece:!1,lapTimes:[],time:[]}),Object.defineProperties(this,{name:{enumerable:!0,get:function get(){return t}},radius:{enumerable:!0,get:function get(){return _this2.r+_this2.strokeWidth/2}}})}Object.defineProperties(r.prototype,{init:{enumerable:!0,value:function value(){var _this3=this;if(!(this.svg instanceof SVGElement))throw new Error("RaceTrack.init requires valid svg element!");return this.svg.getElementById("gTrack")||this.svg.appendChild(this.gTrack),this.svg.getElementById("gCars")||this.svg.appendChild(this.gCars),this.simulation.force("fCollide",d3.forceCollide(4)),this.simulation.nodes().forEach(function(t,e){t.lapTimes=[],t.x=-10*(e+1),t.y=-3*Math.pow(-1,e),t.vx=.9,t.vy=0,t.trackAhead=_this3.gradients.slice()}),this.moveCars(),this.simulation.alphaDecay(0),this.simulation.velocityDecay(.01),this.simulation.on("tick",function(){_this3.onTick()}),this}},onTick:{value:function value(){var _this4=this;if(this.simulation.nodes(this.simulation.nodes()),requestAnimationFrame(function(t){_this4.time=t}),this.moveCars(),this.listCars(),0!==this.simulation.nodes().length)return Math.abs(this.simulation.nodes()[0].vx)<.005&&Math.abs(this.simulation.nodes()[0].vy)<.005&&(this.simulation.stop(),console.log("Sam, stopped!")),this;this.simulation.stop()}},moveCars:{value:function value(){var _this5=this;return d3.selectAll("#gCars circle").attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}),this.simulation.nodes().forEach(function(t,e,i){if(_this5.rails.forEach(function(e){var i=function(t,e){var i=[e.x+e.vx,e.y+e.vy],a=function a(t){return Math.hypot(t.x-i[0],t.y-i[1])},r=t.getTotalLength();var s,n,o,h=16,l=Number.POSITIVE_INFINITY;for(var _e2=0;_e2<=r;_e2+=h){var _i2=t.getPointAtLength(_e2),_r=a(_i2);_r<l&&(s=_i2,n=_e2,l=_r)}if(l>=2*e.radius)return{distance:l};h/=2;for(;h>.5;){var _e3=n-h,_i3=t.getPointAtLength(_e3),c=a(_i3),d=n+h;o=t.getPointAtLength(d);var u=a(o);_e3>=0&&c<l?(s=_i3,n=_e3,l=c):d<=r&&u<l?(s=o,n=d,l=u):h/=2}return{distance:l,after:o,best:s}}(e,t);if(i.distance<=t.radius){var _e4=[i.after.y-i.best.y,i.best.x-i.after.x];var _a=Math.hypot.apply(Math,_toConsumableArray(_e4));_e4=_e4.map(function(t){return t/_a});var _r2=[t.x-i.best.x,t.y-i.best.y];Math.acos((_r2[0]*_e4[0]+_r2[1]*_e4[1])/Math.hypot.apply(Math,_r2))>=Math.PI/2&&(_e4[0]=-_e4[0],_e4[1]=-_e4[1]);var _s=t.vx*_e4[0]+t.vy*_e4[1];if(Math.acos(_s/Math.hypot(t.vx,t.vy))<Math.PI/2)return;var n=Math.random()+1,o=[],h=0;do{n+=.05,o=[n*_s*_e4[0],n*_s*_e4[1]],h=Math.hypot(t.x+t.vx-o[0]-i.after.x,t.y+t.vy-o[1]-i.after.y)}while(Math.abs((t.vx-o[0])*_e4[0]+(t.vy-o[1])*_e4[1])<=Math.abs(_s)&&h<t.radius&&n<3);if(n<2){var _i4=[-_e4[1],_e4[0]];Math.acos((t.vx*_i4[0]+t.vy*_i4[1])/Math.hypot(t.vx,t.vy))>Math.PI/2&&(_i4[0]*=-1,_i4[1]*=-1);var _a2=t.vx*_i4[0]+t.vy*_i4[1];for(n=.1;Math.hypot(t.vx-o[0],t.vy-o[1])<.6*Math.hypot(t.vx,t.vy)&&n<1;){n+=.1,o[0]-=.1*_a2*_i4[0],o[1]-=.1*_a2*_i4[1]}for(;Math.hypot(t.vx-o[0],t.vy-o[1])>Math.hypot(t.vx,t.vy);){o[0]+=.05*_a2*_i4[0],o[1]+=.05*_a2*_i4[1]}}t.vx-=o[0],t.vy-=o[1]}}),t.nextPiece){var _a3=_this5.gradients.indexOf(t.trackAhead[0]);if(!t.time.some(function(e){return e.lap===t.lapTimes.length&&e.piece===_a3})&&(t.time.push({lap:t.lapTimes.length,piece:_a3,time:_this5.time}),0===_a3&&(t.lapTimes.push(_this5.time),t.lapTimes.length>_this5.laps)))return t.x=_this5.extrema[0][0],t.y=_this5.extrema[1][0],void i.splice(e,1);t.trackAhead.push(t.trackAhead.shift()),t.nextPiece=!1}t.previousPiece&&(t.trackAhead.unshift(t.trackAhead.pop()),t.previousPiece=!1),(t.x<_this5.extrema[0][0]-10||t.x>_this5.extrema[0][1]+10||t.y<_this5.extrema[1][0]-10||t.y>_this5.extrema[1][1]+10)&&(console.log("Sam, car out of bounds!"),_this5.simulation.stop())}),this}},setTrack:{enumerable:!0,value:function value(t){var _this6=this;this.gradients=t.filter(function(t){return t instanceof a});var e=[0,0];var r=[[0,0],[0,0]],s=[[],[]];this.rails=new Array(2).fill({});var n=[];this.gTrack.innerHTML="",this.gradients.forEach(function(t,a){e[0]+=t.delta[0],e[1]+=t.delta[1],n.push([e[0],e[1]]),t.x=e[0],t.y=e[1],t.force&&_this6.simulation.force("piece".concat(a),t.force);var o=Math.acos(t.gradient[0]/Math.hypot.apply(Math,_toConsumableArray(t.gradient)));-1===Math.sign(t.gradient[1])&&(o=2*Math.PI-o);var h={x1:e[0]+t.width*Math.sin(o),y1:e[1]-t.width*Math.cos(o),x2:e[0]-t.width*Math.sin(o),y2:e[1]+t.width*Math.cos(o)};t.m=(h.y2-h.y1)/(h.x2-h.x1),t.b=-t.m*h.x1+h.y1;var l=document.createElementNS(i,"line");s[0].push({before:[h.x1-t.width*Math.cos(o)/t.rail[0],h.y1-t.width*Math.sin(o)/t.rail[0]],is:[h.x1,h.y1],after:[h.x1+t.width*Math.cos(o)/t.rail[0],h.y1+t.width*Math.sin(o)/t.rail[0]]}),s[1].push({before:[h.x2-t.width*Math.cos(o)/t.rail[1],h.y2-t.width*Math.sin(o)/t.rail[1]],is:[h.x2,h.y2],after:[h.x2+t.width*Math.cos(o)/t.rail[1],h.y2+t.width*Math.sin(o)/t.rail[1]]}),r[0][0]=Math.min(r[0][0],h.x1,h.x2),r[0][1]=Math.max(r[0][1],h.x1,h.x2),r[1][0]=Math.min(r[1][0],h.y1,h.y2),r[1][1]=Math.max(r[1][1],h.y1,h.y2),Object.entries(h).forEach(function(_ref){var _ref2=_slicedToArray(_ref,2),t=_ref2[0],e=_ref2[1];l.setAttribute(t,e)}),l.classList.add("checkpoint"),0===a&&l.classList.add("start-line"),_this6.gTrack.appendChild(l),d3.select("svg #gTrack").append("circle").attr("cx",t.x).attr("cy",t.y).attr("r",0===a?1.5:2).attr("fill",t.color||"whitesmoke").attr("strokeWidth",0===a?"0.5px":"0").attr("stroke",0===a?"white":"none")}),this.extrema=r,s.forEach(function(t,e){t.push(t[0]);var a=document.createElementNS(i,"path"),r=[];t.forEach(function(e,i){0===i?r.push("M".concat(e.is.join(","))):r.push("C".concat([t[i-1].after.join(" "),e.before.join(" "),e.is.join(" ")].join(",")))}),a.setAttribute("d",r.join("")),_this6.gTrack.appendChild(a),_this6.rails[e]=a});var o=r[0][1]-r[0][0]+20,h=r[1][1]-r[1][0]+20,l=r[0][0]-10,c=r[1][0]-10;return o>h?(h=4*o/5,c=(r[1][0]+r[1][1]-h)/2):(o=5*h/4,l=(r[0][0]+r[0][1]-o)/2),this.svg.setAttribute("viewBox","".concat(l," ").concat(c," ").concat(o," ").concat(h)),d3.select("svg").append("g").selectAll("path").data([n]).enter().append("path").attr("d",d3.line().curve(d3.curveBasisClosed)).classed("lane-line",!0),this}},setCars:{enumerable:!0,value:function value(t){return d3.select("svg #gCars").selectAll("circle").data(t).enter().append("circle").classed("car",!0).attr("fill",function(t){return t.color}).attr("stroke",function(t){return t.color2}).attr("stroke-width",function(t){return t.strokeWidth}).attr("r",function(t){return t.r}).attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}),this.simulation.nodes(t),this.cars=t.slice(),this}},listCars:{enumerable:!0,value:function value(){var t=document.querySelector("ul#positions");return t.innerHTML="",this.cars.sort(function(t,e){return 0===t.time.length&&0===e.time.length?0:0===t.time.length?1:0===e.time.length||t.time.length>e.time.length?-1:t.time.length<e.time.length||t.time[t.time.length-1].time>e.time[e.time.length-1].time?1:t.time[t.time.length-1].time<e.time[e.time.length-1].time?-1:0}).forEach(function(e){var i=document.createElement("li");i.innerText=e.name,t.appendChild(i)}),this}}}),Object.defineProperties(s.prototype,{})}]);