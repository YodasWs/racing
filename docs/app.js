"use strict";function _construct(Parent,args,Class){if(_isNativeReflectConstruct()){_construct=Reflect.construct}else{_construct=function _construct(Parent,args,Class){var a=[null];a.push.apply(a,args);var Constructor=Function.bind.apply(Parent,a);var instance=new Constructor;if(Class)_setPrototypeOf(instance,Class.prototype);return instance}}return _construct.apply(null,arguments)}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true}catch(e){return false}}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){o.__proto__=p;return o};return _setPrototypeOf(o,p)}function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_unsupportedIterableToArray(arr,i)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(arr,i){var _i=arr==null?null:typeof Symbol!=="undefined"&&arr[Symbol.iterator]||arr["@@iterator"];if(_i==null)return;var _arr=[];var _n=true;var _d=false;var _s,_e;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i["return"]!=null)_i["return"]()}finally{if(_d)throw _e}}return _arr}function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_unsupportedIterableToArray(arr)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}function _iterableToArray(iter){if(typeof Symbol!=="undefined"&&iter[Symbol.iterator]!=null||iter["@@iterator"]!=null)return Array.from(iter)}function _arrayWithoutHoles(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr)}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i]}return arr2}function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}!function(e){var t={};function a(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,a),i.l=!0,i.exports}a.m=e,a.c=t,a.d=function(e,t,n){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==_typeof(e)&&e&&e.__esModule)return e;var n=Object.create(null);if(a.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e){a.d(n,i,function(t){return e[t]}.bind(null,i))}return n},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=1)}([function(e,t){e.exports=function(e){var _this=this;Object.assign(this,{gradient:[1,0],delta:[0,0],width:20,rail:[.5,.5]},e);var t=Math.hypot.apply(Math,_toConsumableArray(this.gradient));var a=Math.acos(this.gradient[0]/t);this.gradient[1]<0&&(a=2*Math.PI-a),this.α=a,this.force=function(){var e=[];var t=_this;function a(a){e.forEach(function(e){if(0===e.trackAhead.length)return;if(e.trackAhead[0]!==t)return;var n=Math.hypot(e.vx,e.vy),i=[e.vx/n,e.vy/n],r=t.gradient.map(function(e){return e/Math.hypot.apply(Math,_toConsumableArray(t.gradient))});var o=[r[0]-i[0],r[1]-i[1]];var s=Math.acos((o[0]*i[0]+o[1]*i[1])/Math.hypot.apply(Math,_toConsumableArray(o)));(Number.isNaN(s)||180*s/Math.PI<Number.EPSILON)&&(o=[0,0]);var c=Math.hypot.apply(Math,_toConsumableArray(o));c>1?o=o.map(function(e){return e/c*.02}):c>0&&(o=o.map(function(e){return .02*e})),o=o.map(function(e,t){return e+r[t]*(1/7)}),e.vx+=o[0]*a,e.vy+=o[1]*a;var l=[e.x+e.vx,e.y+e.vy];if(Number.isFinite(t.m)&&Number.isFinite(t.b)&&0!==t.α&&t.α!==Math.PI&&t.α!==2*Math.PI){var _a=t.m*l[0]+t.b;t.α>0&&t.α<Math.PI&&_a<=l[1]&&(e.nextPiece=!0),t.α>Math.PI&&_a>=l[1]&&(e.nextPiece=!0)}else 0===t.α&&t.x<l[0]&&(e.nextPiece=!0),t.α===Math.PI&&t.x>l[0]&&(e.nextPiece=!0);var d=e.trackAhead.slice(-1).pop();if(Number.isFinite(d.m)&&Number.isFinite(d.b)&&0!==d.α&&d.α!==Math.PI&&d.α!==2*Math.PI){var _t=d.m*e.x+d.b;d.α>0&&d.α<Math.PI&&_t>e.y&&(e.previousPiece=!0),d.α>Math.PI&&_t<e.y&&(e.previousPiece=!0)}else 0===d.α&&d.x>e.x&&(e.previousPiece=!0),d.α===Math.PI&&d.x<e.x&&(e.previousPiece=!0);e.previousPiece&&(e.nextPiece=!1)})}return a.initialize=function(t){e=t},a}()}},function(e,t,a){e.exports=a(2)},function(e,t,a){var n={};a(3),n.cSuzuka=a(4),n.cOval=a(5);a(0);var i=a(6),r=a(8);yodasws.page("home").setRoute({template:"pages/home.html",route:"/"}).on("load",function(){var e=document.querySelector("svg#scene");document.getElementById("btnTick").remove();var t=document.createElement("button");t.innerText="Flag!",t.addEventListener("click",function(e){e.preventDefault(),console.error("Sam, flag!")}),document.querySelector("form").appendChild(t);var a=new i(e,[new r("Alice, TX",{color:"lightgreen",color2:"orange",rgb:[144,238,144]}),new r("Brooklyn, NY",{color:"white",color2:"black",r:3,strokeWidth:3,rgb:[68,68,68]}),new r("Charlotte, NC",{color:"#249E57",color2:"lightgrey",r:3.5,strokeWidth:2,rgb:[36,158,87]}),new r("Dallas, TX",{color:"red",color2:"#000191",r:3.5,strokeWidth:2,rgb:[0,1,145]}),new r("Edison, NJ",{color:"white",color2:"#00375D",r:3,strokeWidth:3,rgb:[48,103,141]}),new r("Florence, TN",{color:"#1E3258",color2:"#BF1F2D",r:3.5,strokeWidth:2,rgb:[191,31,45]}),new r("Garland, TX",{color:"#E61234",color2:"#FDB920",r:3,strokeWidth:3,rgb:[253,185,32]}),new r("Helena, AL",{color:"white",color2:"#A49C44",r:3,strokeWidth:3,rgb:[180,156,38]})].sort(function(){return 0}),Object.assign({},n.cSuzuka,{laps:10}));a.simulation.stop(),a.init(),l(a),document.getElementById("btnStart").focus(),document.getElementById("btnStart").addEventListener("click",function(e){switch(e.preventDefault(),e.currentTarget.innerText){case"Start":console.log("Sam, start!"),a.simulation.stop(),a.init(),a.simulation.alpha(1),setTimeout(function(e){a.simulation.restart(),e.innerText="Pause",e.disabled=!1,e.focus()},500,e.currentTarget),e.currentTarget.disabled=!0,clearInterval(c);break;case"Pause":a.simulation.stop(),e.currentTarget.innerText="Play";break;case"Play":a.simulation.restart(),e.currentTarget.innerText="Pause";}}),document.getElementById("btnTick")instanceof Element&&document.getElementById("btnTick").addEventListener("click",function(e){e.preventDefault(),a.simulation.tick(),a.onTick()}),document.querySelector("input[type=\"file\"]").addEventListener("change",function(t){var n=t.target.files[0];if("application/json"!==n.type)return void t.preventDefault();var r=new FileReader;r.onload=function(t){var n=JSON.parse(t.target.result);a=i.fromJson(n,e),a.simulation.stop(),l(a);var r=document.querySelector("form #btnExport");r instanceof HTMLElement&&r.removeAttribute("disabled")},r.readAsText(n)})});var o=function(){var e=new EventTarget,t=new Set;var a;return e.addφListener=function(a,n){t.add(a),e.addEventListener("\u03C6Change",function(e){e.detail.φ===a&&n(e)})},e.φChange=function(n,i){t.forEach(function(t){a<=t&&t<n&&e.dispatchEvent(new CustomEvent("\u03C6Change",{detail:{"\u03C6":t}}))}),a=n},e}(),s=function(){var e={"set\u03C6ToActivateCamera":{value:function value(e){var _this2=this;o.addφListener(e,function(e){scene.activeCamera=_this2})}}};return new Proxy(function(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];var _ref=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{},_ref$φRange=_ref["\u03C6Range"],a=_ref$φRange===void 0?[-Math.PI/2,3*Math.PI/2]:_ref$φRange;this.φRange=a,this.uuid=Math.floor(1e3*Math.random()).toString().padStart(3,"0")},{construct:function construct(t,a){var _a2=_slicedToArray(a,2),n=_a2[0],i=_a2[1],r=BABYLON[n];if(!r)throw new TypeError("Unknown camera type '".concat(n,"'"));if(!(r.prototype instanceof BABYLON.TargetCamera))throw new TypeError("Invalid camera type '".concat(n,"'"));var o=Object.create(r.prototype);return r.apply(o,i),t.apply(o,a),Object.defineProperties(o.__proto__,e),o}})}();var c;function l(e){var _ref2=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{},_ref2$OverheadCirclin=_ref2.OverheadCirclingSpeed,t=_ref2$OverheadCirclin===void 0?5:_ref2$OverheadCirclin,_ref2$filmCountdownOn=_ref2.filmCountdownOnly,a=_ref2$filmCountdownOn===void 0?!1:_ref2$filmCountdownOn,_ref2$doExport=_ref2.doExport,n=_ref2$doExport===void 0?!1:_ref2$doExport,_ref2$targetFrameRate=_ref2.targetFrameRate,i=_ref2$targetFrameRate===void 0?30:_ref2$targetFrameRate,_ref2$renderFrameRate=_ref2.renderFrameRate,r=_ref2$renderFrameRate===void 0?30:_ref2$renderFrameRate;clearInterval(c);var _BABYLON=BABYLON,d=_BABYLON.AbstractMesh,h=_BABYLON.Animation,m=_BABYLON.AnimationGroup,u=_BABYLON.Color3,p=_BABYLON.Color4,g=_BABYLON.DirectionalLight,f=_BABYLON.Engine,y=_BABYLON.FollowCamera,w=_BABYLON.Mesh,v=_BABYLON.MeshBuilder,x=_BABYLON.Scene,T=_BABYLON.SkyMaterial,E=_BABYLON.StandardMaterial,C=_BABYLON.Texture,b=_BABYLON.UniversalCamera,A=_BABYLON.Vector3,M=_BABYLON.GUI,P=_BABYLON.GrassProceduralTexture,k=_BABYLON.DynamicTerrain,I=document.querySelector("canvas#replay"),S=new f(I,!0),L=new x(S);L.useRightHandedSystem=!0,L.ambientColor=new u(.8,.8,.8);var O={cross:Math.max(Math.abs(e.extrema[0][1]-e.extrema[0][0]),Math.abs(e.extrema[1][1]-e.extrema[1][0])),height:e.extrema[1][1]-e.extrema[1][0],width:e.extrema[0][1]-e.extrema[0][0],midpoint:new A((e.extrema[0][0]+e.extrema[0][1])/2,0,(e.extrema[1][0]+e.extrema[1][1])/2)};Object.entries({sPosition:{get:function get(){var e=[this.position.x-O.midpoint.x,this.position.y-O.midpoint.y,this.position.z-O.midpoint.z],t=Math.hypot.apply(Math,e);return{r:t,"\u03C6":0===e[0]?0:Math.atan(e[2]/e[0])+(e[0]<0?Math.PI:0),"\u03B8":0===e[1]?0:Math.acos(Math.hypot(e[0]/t,e[2]/t)/e[1]/t)}},set:function set(){for(var _len=arguments.length,e=new Array(_len),_key=0;_key<_len;_key++){e[_key]=arguments[_key]}var _ref3=Array.isArray(e[0])?e[0]:e,_ref4=_slicedToArray(_ref3,3),t=_ref4[0],a=_ref4[1],n=_ref4[2];this.position=new A(t*Math.sin(n)*Math.cos(a)+O.midpoint.x,t*Math.sin(n)*Math.sin(a)+O.midpoint.z,t*Math.cos(n)+O.midpoint.y)}}}).forEach(function(_ref5){var _ref6=_slicedToArray(_ref5,2),e=_ref6[0],t=_ref6[1];[BABYLON.TransformNode.prototype,BABYLON.Camera.prototype].forEach(function(a){a.hasOwnProperty(e)||Object.defineProperty(a,e,t)})});var N=new T("sky",L);N.backFaceCulling=!1,N.luminance=.2,N.useSunPosition=!0,N.sunPosition=new A(10,3,1),N.turbidity=2,N.rayleigh=3,N.cameraOffset.y=200;var R=w.CreateSphere("skyBox",5,2*O.cross,L);R.material=N,R.position=O.midpoint;var _=new g("light2",N.sunPosition.negate(),L);_.diffuse=new u(1,1,1),_.intensity=.5;var F=[new s("UniversalCamera",["cameraTopLeftCorner",new A(e.extrema[0][0],20,e.extrema[1][0]-30),L],{"\u03C6Range":[150*Math.PI/180,5*Math.PI/4]}),new s("UniversalCamera",["cameraOverheadCenter",new A(-35,160,2*e.extrema[1][1]),L]),new s("UniversalCamera",["cameraTopRightCorner",new A(e.extrema[0][1]+10,20,e.extrema[1][0]-10),L],{"\u03C6Range":[-Math.PI/2,10*Math.PI/180]}),new s("UniversalCamera",["cameraBackMidfield",new A(-50,50,e.extrema[1][1]+70),L],{"\u03C6Range":[0*Math.PI/180,125*Math.PI/180]}),new s("UniversalCamera",["cameraCircling",new A(e.extrema[0][0]+200,20,e.extrema[1][0]-10),L])];F.find(function(e){return"cameraTopRightCorner"===e.id}).setφToActivateCamera(0);var z=new E("grass",L);z.ambientColor=new u(127/255,229/255,112/255),z.ambientTexture=new P("grassPT",256,L),z.specularColor=new u(80/255,80/255,80/255);var B=new E("asphalt",L);B.ambientColor=new u(183/255,181/255,186/255),B.specularColor=new u(96/255,96/255,96/255);var G=new P("asphaltPT",256,L);G.grassColors=[new u(183/255,181/255,186/255),new u(135/255,133/255,138/255),new u(151/255,149/255,154/255)],B.ambientTexture=G;var j=new E("black",L);j.diffuseColor=new u(1/255,1/255,1/255),j.ambientColor=new u(1/255,1/255,1/255);var D=new E("trackSiding",L);D.diffuseColor=new u(235/255,88/255,99/255),D.ambientColor=new u(235/255,88/255,99/255),D.specularColor=new u(160/255,160/255,160/255);var H=function(){var e=new Float32Array(12e4);for(var _t2=0;_t2<200;_t2++){for(var _a3=0;_a3<200;_a3++){var _n2=[5*(_a3-100),-.05,5*(_t2-100)];e[3*(200*_t2+_a3)+0]=_n2[0],e[3*(200*_t2+_a3)+1]=_n2[1],e[3*(200*_t2+_a3)+2]=_n2[2]}}var t=new k("dtGround",{mapData:e,mapSubX:200,mapSubZ:200,terrainSub:60},L);return t.updateCameraLOD=function(e){return Math.abs(e.globalPosition.y/10|0)},t.mesh.material=z,t.isAlwaysVisible=!0,t}();(function(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var _e$trackEdge=e.trackEdge,t=_e$trackEdge===void 0?-20:_e$trackEdge,_e$sideHeight=e.sideHeight,a=_e$sideHeight===void 0?2:_e$sideHeight,_e$front=e.front,n=_e$front===void 0?-50:_e$front,_e$back=e.back,i=_e$back===void 0?-150:_e$back,_e$left=e.left,r=_e$left===void 0?-100:_e$left,_e$right=e.right,o=_e$right===void 0?100:_e$right,_e$height=e.height,s=_e$height===void 0?50:_e$height,c=v.CreateRibbon("stands",{closePath:!1,pathArray:[[new A(o,-.03,t),new A(o,-.03,n),new A(o,s,i)],[new A(r,-.03,t),new A(r,-.03,n),new A(r,s,i)]]},L),l=new E("crowd",L);l.ambientColor=new u(170/255,170/255,170/255),l.specularColor=new u(64/255,64/255,64/255);var d=new P("crowdPT",256,L);d.grassColors=[new u(165/255,165/255,215/255),new u(215/255,165/255,170/255),new u(165/255,215/255,165/255)],l.ambientTexture=d,c.material=l;var h=v.CreateRibbon("standsSides",{sideOrientation:w.DOUBLESIDE,closePath:!1,pathArray:[[new A(o,-.03,t),new A(o,-.03,n),new A(o,-.03,i),new A(o,-.03,i),new A(r,-.03,i),new A(r,-.03,i),new A(r,-.03,n),new A(r,-.03,t)],[new A(o,-.03+a,t),new A(o,-.03+a,n),new A(o,s+a,i),new A(o,s+a,i),new A(r,s+a,i),new A(r,s+a,i),new A(r,-.03+a,n),new A(r,-.03+a,t)]]},L),m=new E("standsSiding",L);m.diffuseColor=new u(99/255,99/255,99/255),m.ambientColor=new u(131/255,131/255,131/255),m.specularColor=new u(208/255,208/255,208/255),h.material=m})(e.grandStand),function(){var a=[],n=new h("spinningCamera","position",r,h.ANIMATIONTYPE_VECTOR3,h.ANIMATIONLOOPMODE_CYCLE),_ref7=O.height<O.width?[.7*O.width,1*O.height]:[O.width*(.5+1/6),O.height*(.5+1/6)],_ref8=_slicedToArray(_ref7,2),i=_ref8[0],o=_ref8[1];for(var _e2=0;_e2<360;_e2++){a.push({frame:Math.floor(_e2*t),value:new A(Math.cos((180+_e2)*Math.PI/180)*i+O.midpoint.x,100,Math.sin((180+_e2)*Math.PI/180)*o+O.midpoint.z)})}n.setKeys(a);var s=new m("animeFlyover");s.normalize(0,a[a.length-1].frame);var c=e.cars.slice(0,3),l=new A(c.reduce(function(e,t){return e+t.posn[0].x},0)/c.length,c.reduce(function(e,t){return e+t.radius},0)/c.length,c.reduce(function(e,t){return e+t.posn[0].y},0)/c.length);F.filter(function(e){return"cameraCircling"===e.id}).forEach(function(e){e.lockedTarget=l,s.addTargetedAnimation(n,e)}),s.play(!0)}();var V=[[],[]],U=[[],[]];e.rails.forEach(function(e,t){var a=e.getTotalLength();for(var _n3=0;_n3<100;_n3+=.2){var _i2=e.getPointAtLength(a*_n3/100);V[t].push(new A(_i2.x,0,_i2.y)),U[t].push(new A(_i2.x,5,_i2.y))}}),U.forEach(function(e,t){var a=[e,V[t]];v.CreateRibbon("rail"+t,{sideOrientation:w.DOUBLESIDE,pathArray:a,closePath:!0},L).material=D});v.CreateRibbon("track",{pathArray:V.reverse(),closePath:!0},L).material=B;var q=e.gradients[0];v.CreateLines("startLine",{points:[new A(q.x-q.width*Math.sin(q.α),.02,q.y+q.width*Math.cos(q.α)),new A(q.x+q.width*Math.sin(q.α),.02,q.y-q.width*Math.cos(q.α))],colors:new Array(2).fill(new p(0,0,0,1)),useVertexAlpha:!1},L).material=j;var $=e.cars.slice();$.forEach(function(e){var t=e.posn[0];if(e.sphere=v.CreateSphere("sphere"+e.name,{segments:16,diameter:2*e.radius},L),e.sphere.position=new A(t.x,e.radius,t.y),Array.isArray(e.rgb)){var _t3=new E(e.name+"Material",L);_t3.diffuseColor=_construct(u,_toConsumableArray(e.rgb.map(function(e){return e/255}))),_t3.ambientColor=_construct(u,_toConsumableArray(e.rgb.map(function(e){return e/255}))),_t3.diffuseTexture=new C("ball.png",L),e.sphere.material=_t3}});var W=7;var Y=n?h.ANIMATIONLOOPMODE_CONSTANT:h.ANIMATIONLOOPMODE_CYCLE;var Z;var J={flyover:{playTime:a?1:20,nextStage:"countdown",loopAnimes:!0,camera:F.find(function(e){return"cameraCircling"===e.id}),cameras:F},countdown:{animes:new m("animeCountdown"),camera:F.find(function(e){return"cameraOverheadCenter"===e.id}),nextStage:"race",playTime:3.5},race:{animes:new m("animeRace"),secondsToSwitchCameras:5,rotateCamera:!0,cameras:F,nextStage:"afterRace"},afterRace:{secondsToSwitchCameras:2.5,rotateCamera:!0,playTime:20,cameras:F}};J.events=new EventTarget,J.events.addEventListener("start",function(e){var _this3=this;Z=e.detail;var t=J[Z];if(!t)throw Error("Could not find stage "+Z);"string"==typeof t.camera?L.activeCamera=F.find(function(e){return e.id===t.camera}):t.camera instanceof BABYLON.TargetCamera&&(L.activeCamera=t.camera),"function"==typeof t.onStartStage&&t.onStartStage(),t.animes instanceof m&&t.animes.play(!!t.loopAnimes),Number.isFinite(t.playTime)&&t.playTime>0&&setTimeout(function(){_this3.dispatchEvent(new CustomEvent("end",{detail:Z}))},1e3*t.playTime*i/r)}),J.events.addEventListener("end",function(e){var t=e.detail;if(J[t]){var _e3=J[t];"function"==typeof _e3.onEndStage&&_e3.onEndStage(),_e3.nextStage&&J[_e3.nextStage]&&this.dispatchEvent(new CustomEvent("start",{detail:_e3.nextStage})),_e3.overlay&&_e3.overlay.autoDispose&&_e3.overlay.dispose()}}),J.flyover,function(e){var t=M.AdvancedDynamicTexture,a=M.Control,n=M.Rectangle,o=M.TextBlock,s=new t.CreateFullscreenUI("myUI");s.useInvalidateRectOptimization=!1,s.renderScale=2,e.overlay=s;var c=new n;c.horizontalAlignment=a.HORIZONTAL_ALIGNMENT_CENTER,c.verticalAlignment=a.VERTICAL_ALIGNMENT_CENTER,c.background="white",c.height="0.1",c.width="0.25",c.paddingLeft="20%",c.clipChildren=!1,c.clipContent=!1,c.cornerRadius=100;var l=new o;l.fontSize=100,l.fontWeight="bold",l.color="black",l.textHorizontalAlignment=a.HORIZONTAL_ALIGNMENT_CENTER,l.textVerticalAlignment=a.VERTICAL_ALIGNMENT_CENTER,l.horizontalAlignment=a.HORIZONTAL_ALIGNMENT_CENTER,l.verticalAlignment=a.VERTICAL_ALIGNMENT_CENTER,c.addControl(l);var d,h=3;var m=function m(){3===h&&s.addControl(c),l.text=h>0?h.toString():"Go!",h--};e.onStartStage=function(){setTimeout(function(){m(),d=setInterval(m,1e3*i/r)},500*i/r)},e.onEndStage=function(){d&&(m(),clearInterval(d)),setTimeout(function(){s.removeControl(c),s.dispose()},1e3*i/r)}}(J.countdown);var X=function X(e,t){return t.tick-e.tick},K=function(e){var t=[];var a=function a(){t=e.map(function(e){return{name:e.name,radius:e.radius,lenTime:e.time.length,time:e.time.slice().sort(X),posn:e.posn.slice().sort(X)}})};a();var n=function n(e){return t.forEach(function(t){t.curTime=t.time.find(function(t){return t.tick<=e}),t.curPosn=t.posn.find(function(t){return t.tick<=e})}),t.sort(function(e,t){if(0===e.lenTime&&0===t.lenTime)return 0;if(0===e.lenTime)return 1;if(0===t.lenTime)return-1;if(void 0===e.curTime&&void 0===t.curTime)return 0;if(void 0===e.curTime)return 1;if(void 0===t.curTime)return-1;if(e.curTime.lap<t.curTime.lap)return 1;if(e.curTime.lap>t.curTime.lap)return-1;if(e.curTime.piece!==t.curTime.piece){if(0===e.curTime.piece)return-1;if(0===t.curTime.piece)return 1;if(e.curTime.piece<t.curTime.piece)return 1;if(e.curTime.piece>t.curTime.piece)return-1}return e.curTime.tick<t.curTime.tick?-1:e.curTime.tick>t.curTime.tick?1:0}),t};return n.reset=a,n}($);var Q;if($[0].posn.length>1){var _t4=0;var _a4=2*Math.PI;if($.forEach(function(e){var n=0,i=0;var o=[],s=[new h("moveAnime"+e.name,"position",r,h.ANIMATIONTYPE_VECTOR3,Y),new h("spinAnime"+e.name,"rotation",r,h.ANIMATIONTYPE_VECTOR3,Y)];s.forEach(function(e){return o.push([])}),e.posn.forEach(function(r){var s=3*r.tick;o[0].push({frame:s,value:new A(r.x,e.radius,r.y)});var c=Math.hypot(r.vx,r.vy);if(c>0){var _e4=-Math.sign(r.vy)*Math.acos(r.vx/c)%_a4-i%_a4;for(;Math.abs(_e4)>Math.PI;){_e4-=Math.sign(_e4)*_a4}i+=_e4,n-=c*Math.PI/16}o[1].push({frame:s,value:new A(0,i,n)}),_t4=Math.max(_t4,r.tick)}),W=o.reduce(function(e,t){return Math.max(e,t[t.length-1].frame)},W),s.forEach(function(t,a){t.setKeys(o[a]),J.race.animes.addTargetedAnimation(t,e.sphere)})}),!(document.querySelector("form #btnExport")instanceof HTMLElement)){var _t5=document.createElement("button");_t5.setAttribute("id","btnExport"),_t5.innerText="Export",_t5.addEventListener("click",function(){_t5.setAttribute("disabled","disabled"),clearInterval(c),l(e,{OverheadCirclingSpeed:4,doExport:!0,targetFrameRate:60,renderFrameRate:2})});var _a5=document.querySelector("form");_a5 instanceof Element&&_a5.appendChild(_t5)}(function(){var e=[],a=[new h("cameraTrack","position",r,h.ANIMATIONTYPE_VECTOR3,Y)];a.forEach(function(t){return e.push([])});for(var _a6=0;_a6<_t4;_a6++){var _t6=K(_a6).slice(0,3),_n4=[_t6.reduce(function(e,t){return e+t.curPosn.x},0)/_t6.length,_t6.reduce(function(e,t){return e+t.radius},0)/_t6.length,_t6.reduce(function(e,t){return e+t.curPosn.y},0)/_t6.length];e[0].push({frame:3*_a6,value:_construct(A,_n4),"\u03C6":0===_n4[0]?0:Math.atan(_n4[2]/_n4[0])})}K.reset(),W=e.reduce(function(e,t){return Math.max(e,t[t.length-1].frame)},W),Q=new d("raceCameraTarget",L),Q.position=e[0][0].value,J.race.cameras.forEach(function(e){return e.lockedTarget=Q}),F.filter(function(e){return"cameraCircling"===e.id}).forEach(function(e){e.lockedTarget=Q}),a.forEach(function(t,a){t.setKeys(e[a]),J.race.animes.addTargetedAnimation(t,Q)})})(),J.race.animes.normalize(0,W)}else delete J.flyover.nextStage,J.flyover.cameras.forEach(function(e){return e.setTarget(new A(0,4.5,0))});var ee=function(){var t=M.AdvancedDynamicTexture,a=M.Control,n=M.StackPanel,i=M.TextBlock,r=M.XmlLoader,o=new t.CreateFullscreenUI("myUI");o.useInvalidateRectOptimization=!1,o.renderScale=2,J.race.overlay=o,J.race.overlay.autoDispose=!0;var s=new n;s.horizontalAlignment=a.HORIZONTAL_ALIGNMENT_LEFT,s.verticalAlignment=a.VERTICAL_ALIGNMENT_TOP,s.background="white",s.width="0.14",s.top="0",s.left="0",s.clipChildren=!1,s.clipContent=!1,J.events.addEventListener("start",function(e){"flyover"===e.detail&&o.addControl(s)});var c=new n;c.horizontalAlignment=a.HORIZONTAL_ALIGNMENT_LEFT,c.verticalAlignment=a.VERTICAL_ALIGNMENT_BOTTOM,c.background="white",c.width="0.1",c.clipChildren=!1,c.clipContent=!1;var l=new i;l.fontSize=70,l.height="110px",l.color="black",l.paddingLeft="20px",l.paddingBottom="20px",l.paddingTop="20px",l.textHorizontalAlignment=a.HORIZONTAL_ALIGNMENT_LEFT,l.textVerticalAlignment=a.VERTICAL_ALIGNMENT_BOTTOM,c.addControl(l);var d=new Array($.length).fill(0).map(function(e,t){var n=new i;return n.fontSize=70,n.color="black",n.paddingLeft="10px",n.height="90px",0===t&&(n.paddingTop="20px",n.height="110px"),n.textHorizontalAlignment=a.HORIZONTAL_ALIGNMENT_LEFT,n.textVerticalAlignment=a.VERTICAL_ALIGNMENT_TOP,s.addControl(n),n});return function(t){K(t).forEach(function(t,a){0===a&&t.curTime&&(o.addControl(c),t.curTime.lap>e.laps?l.text="Finish!":t.curTime.lap>0?l.text="Lap ".concat(t.curTime.lap," / ").concat(e.laps):l.text="GO!"),d[a].text="".concat(a+1," ").concat(t.name)})}}();(function(e){var t=M.AdvancedDynamicTexture,a=M.Control,n=M.StackPanel,i=M.TextBlock,r=J.afterRace,o=new t.CreateFullscreenUI("myUI");o.useInvalidateRectOptimization=!1,o.renderScale=2,r.overlay=o;var s=new n;s.horizontalAlignment=a.HORIZONTAL_ALIGNMENT_RIGHT,s.verticalAlignment=a.VERTICAL_ALIGNMENT_CENTER,s.background="white",s.width="0.31",s.clipChildren=!1,s.clipContent=!1;var c=new Array($.length).fill(0).map(function(e,t){var n=new i;return n.fontSize=150,n.color="black",n.paddingLeft="10px",n.height=n.fontSize+30+"px",n.textHorizontalAlignment=a.HORIZONTAL_ALIGNMENT_LEFT,n.textVerticalAlignment=a.VERTICAL_ALIGNMENT_TOP,s.addControl(n),n});J.events.addEventListener("start",function(e){"afterRace"===e.detail&&o.addControl(s)}),r.overlay.render=function(){var e=$.reduce(function(e,t){return Math.max(e,t.lapTimes[t.lapTimes.length-1].tick)},0);K(e).forEach(function(e,t){c[t].text="".concat(t+1," ").concat(e.name)})}})(),L.activeCamera=F[0];var te=function(){var e=1;return J.race.animes.onAnimationGroupPlayObservable.add(function(){e=0}),J.race.animes.onAnimationGroupEndObservable.add(function(){e=0}),{pickNextCamera:function pickNextCamera(){if(!0===J[Z].rotateCamera&&ne%J[Z].framesToSwitchCameras==0){if(Q instanceof d){var _t7=e;L.activeCamera;do{if(e++,F[e%F.length].φRange[0]<=Q.sPosition.φ&&Q.sPosition.φ<F[e%F.length].φRange[1])break}while(e%F.length!=_t7%F.length)}else e++;!function(t){if(!Number.isInteger(t)||t<0)throw new TypeError("newActiveCameraIndex must be a nonnegative integer");e=t,L.activeCamera=F[t%F.length]}(e),e%F.length==0&&ie++}}}}(),ae=function(e){return e?new WebMWriter({quality:.95,frameRate:i}):{addFrame:function addFrame(){},complete:function complete(){return Promise.reject()}}}(n);var ne=0,ie=0;Object.entries(J).forEach(function(_ref9){var _ref10=_slicedToArray(_ref9,2),e=_ref10[0],t=_ref10[1];Number.isFinite(t.secondsToSwitchCameras)&&(J[e].framesToSwitchCameras=t.secondsToSwitchCameras*i)}),L.beforeRender=function(e){H.camera!==e.activeCamera&&(H.camera=e.activeCamera,H.camera.position.y<30&&(H.initialLOD=5))},L.afterRender=function(e){n&&("flyover"!==Z||ne>5)&&ae.addFrame(I)},console.log("Sam, max number of frames:",W),Object.entries(J).forEach(function(_ref11){var _ref12=_slicedToArray(_ref11,2),e=_ref12[0],t=_ref12[1];t.animes instanceof m&&("function"==typeof t.onStartAnimation&&t.animes.onAnimationGroupPlayObservable.add(t.onStartAnimation),t.animes.onAnimationGroupEndObservable.add(function(){J.events.dispatchEvent(new CustomEvent("end",{detail:e}))}))}),J.race.animes.onAnimationGroupPlayObservable.add(function(){Z="race",ne=0,ie=0}),J.race.animes.onAnimationGroupEndObservable.add(function(){Z="afterRace",ne=0,ie=0,W=J.afterRace.playTime*i,J.events.dispatchEvent(new CustomEvent("end",{detail:"race"}))}),c=setInterval(function(){L.render(),["flyover","countdown"].includes(Z)&&ee(0),J.race.animes.isPlaying&&ee(ne/3),J[Z].overlay&&"function"==typeof J[Z].overlay.render&&J[Z].overlay.render(ne/3),te.pickNextCamera(),Q instanceof d&&o.φChange(Q.sPosition.φ),ne++,ne%20==0&&n&&console.log("Sam, frame",ne,",",(ne/i).toFixed(3),"seconds");var e=!1;a&&"race"===Z&&ne>=1*i&&(e=!0),"afterRace"===Z&&ne>=J.afterRace.playTime*i&&(e=!0),e&&(console.log("Sam, at end of video!"),n||a?(clearInterval(c),console.log("Sam, done running WebGL animation"),ae.complete().then(function(e){var t=URL.createObjectURL(e),a=document.querySelector("main");if(a instanceof Element){var _e5=document.createElement("a");_e5.innerText="Open  in new window",_e5.setAttribute("target","_blank"),_e5.setAttribute("href",t),a.appendChild(_e5);var _n5=document.createElement("video"),_i3=document.createElement("source");_i3.setAttribute("type","video/webm"),_i3.setAttribute("src",t),_n5.appendChild(_i3),a.appendChild(_n5)}else window.open(t,"_blank")}).catch(function(e){console.error("Sam, videoWriter failed:",e)})):(K.reset(),J.race.animes.play(!1)))},1e3/r),S.resize(),window.addEventListener("resize",function(){S.resize()}),Z||J.events.dispatchEvent(new CustomEvent("start",{detail:"flyover"}))}window.addEventListener("raceEnd",function(e){Array.isArray(e.detail)&&e.detail[0]instanceof i&&l.apply(void 0,_toConsumableArray(e.detail))})},function(e,t){yodasws.page("pageHsr").setRoute({title:"High Speed Rail",template:"pages/hsr/hsr.html",canonicalRoute:"/hsr/",route:"/hsr/?"}).on("load",function(){var e=d3.scaleLinear([0,1],[-300,300]),t=d3.scaleLinear([0,1],[-250,250]),n=d3.create("svg").attr("viewBox",[-300,-250,600,500]).attr("height",500).attr("width",600),i=n.append("g"),r=i.append("g").classed("exits",!0),o=Array.from({length:100},function(e,t){return[(t+1)/51,(100-t)/201]}),s=(r.selectAll("circle").data(o).join("circle").attr("cx",function(t){return e(t[0])}).attr("cy",function(e){return t(e[1])}),Array.from({length:100},function(e,t){return{x:t/100,y:.5}})),c=i.append("g").classed("cars",!0).selectAll("circle").data(s).join("circle"),l=d3.zoom().on("start",function(){n.classed("zoom",!0)}).on("end",function(){n.classed("zoom",!1)}).on("zoom",function(_ref13){var e=_ref13.transform;i.attr("transform",e)});n.call(l).call(l.transform,d3.zoomIdentity),n.on("dragstart",function(e){n.classed("drag",!0)}),document.querySelector("main").append(n.node());var d=d3.forceSimulation(s).alphaDecay(0).velocityDecay(1-Math.pow(.1,2));d.force("forceX",d3.forceX(2)),d.force("lineUp",a(.005)),d.on("tick",function(){c.attr("cx",function(t){return e(t.x)}).attr("cy",function(e){return t(e.y)})}),d.restart()});var a=function(){function e(e){return e.x+e.vx}return function(t){var a,n;function i(){var n=a.length;var i,r;for(var o=0;o<n-1;++o){i=a[o],r=a[o+1];e(r)-e(i)<t&&(i.vx=i.vx-Math.abs(i.vx-r.vx)/2,i.x=Math.min(i.x,r.x-t))}}return i.initialize=function(e,t){a=e,n=t},i}}()},function(e){e.exports=JSON.parse("{\"trackPieces\":[{\"gradient\":[1,0],\"delta\":[0,0],\"width\":20,\"color\":\"black\",\"flyoverPoint\":true},{\"gradient\":[1,0],\"delta\":[150,0],\"width\":20,\"rail\":[[0.5,1.75],[0.25,0.75]],\"flyoverPoint\":true},{\"gradient\":[1,2],\"delta\":[50,30],\"width\":20,\"rail\":[[1,1],[0.6,0.25]]},{\"gradient\":[1,2],\"delta\":[30,60],\"width\":20,\"rail\":[0.5,0.25]},{\"gradient\":[0,1],\"delta\":[8,30],\"width\":20,\"rail\":[[0.5,0.1],[0.25,0.1]]},{\"gradient\":[0,1],\"delta\":[0,20],\"width\":20,\"rail\":[[1.5,2.5],[0.125,0.75]],\"flyoverPoint\":true},{\"gradient\":[-1,0],\"delta\":[-50,50],\"width\":20,\"rail\":[[1.5,1.5],[1,0.125]]},{\"gradient\":[-5,-1],\"delta\":[-60,-10],\"width\":20,\"rail\":[[0.25,1.2],[0.25,2.5]]},{\"gradient\":[-2,3],\"delta\":[-70,40],\"width\":20,\"rail\":[[0.5,2],[0.75,1.5]]},{\"gradient\":[-3,-2],\"delta\":[-70,20],\"width\":20,\"rail\":[[2,0.5],[0.25,0.16667]],\"flyoverPoint\":true},{\"gradient\":[-3,-2],\"delta\":[-60,-40],\"width\":20,\"rail\":[[0.25,0.5],[1,2]]},{\"gradient\":[-2,3],\"delta\":[-70,10],\"width\":20,\"rail\":[[1,0.25],[1.5,0.1]]},{\"gradient\":[-2,3],\"delta\":[-10,15],\"width\":20,\"rail\":[[0.1,2],[0.1,1]]},{\"gradient\":[-3,-2],\"delta\":[-70,20],\"width\":20,\"rail\":[[1.5,0.25],[0.6,0.25]]},{\"gradient\":[-3,-2],\"delta\":[-60,-40],\"width\":20,\"rail\":[[0.25,1],[0.25,2]]},{\"gradient\":[-1,0],\"delta\":[-60,-25],\"width\":20,\"rail\":[[0.7,1],[1,2]]},{\"gradient\":[-1,1],\"delta\":[-55,20],\"width\":20,\"rail\":[[0.2,0.2],[0.75,1]]},{\"gradient\":[-1,0],\"delta\":[-70,40],\"width\":20,\"rail\":[[2,2.5],[1,1.5]],\"flyoverPoint\":true},{\"gradient\":[0,-1],\"delta\":[-80,-70],\"width\":20,\"rail\":[[3,1.2],[1.7,0.75]]},{\"gradient\":[0,-1],\"delta\":[0,-80],\"width\":20,\"rail\":[[1,3],[1,2]],\"color\":\"lightgreen\",\"flyoverPoint\":true},{\"gradient\":[1,0],\"delta\":[90,-90],\"width\":20,\"rail\":[[3,1],[2,1]],\"flyoverPoint\":true},{\"gradient\":[1,0],\"delta\":[90,0],\"width\":20},{\"gradient\":[1,0],\"delta\":[90,0],\"width\":20},{\"gradient\":[1,0],\"delta\":[90,0],\"width\":20},{\"gradient\":[1,0],\"delta\":[90,0],\"width\":20}],\"grandStand\":{\"trackEdge\":-20,\"sideHeight\":2,\"front\":-50,\"back\":-250,\"left\":-400,\"right\":100,\"height\":100}}")},function(e){e.exports=JSON.parse("{\"trackPieces\":[{\"gradient\":[1,0],\"delta\":[0,0],\"width\":20,\"color\":\"black\"},{\"gradient\":[1,0],\"delta\":[20,0],\"width\":20,\"rail\":[1,0.25]},{\"gradient\":[1,1],\"delta\":[27,13],\"width\":20,\"rail\":[1,0.25]},{\"gradient\":[0,1],\"delta\":[13,27],\"width\":20,\"rail\":[1,0.25]},{\"gradient\":[-1,1],\"delta\":[-13,27],\"width\":20,\"rail\":[1,0.25]},{\"gradient\":[-1,0],\"delta\":[-27,13],\"width\":20,\"rail\":[1,0.25],\"color\":\"lightgreen\"},{\"gradient\":[-1,0],\"delta\":[-120,0],\"width\":20,\"rail\":[1,0.25]},{\"gradient\":[-1,-1],\"delta\":[-27,-13],\"width\":20,\"rail\":[1,0.25]},{\"gradient\":[0,-1],\"delta\":[-13,-27],\"width\":20,\"rail\":[1,0.25]},{\"gradient\":[1,-1],\"delta\":[13,-27],\"width\":20,\"rail\":[1,0.25]},{\"gradient\":[1,0],\"delta\":[27,-13],\"width\":20,\"rail\":[1,0.25]}],\"grandStand\":{\"trackEdge\":-20,\"sideHeight\":2,\"front\":-30,\"back\":-100,\"left\":-105,\"right\":25,\"height\":35}}")},function(e,t,a){var n="http://www.w3.org/2000/svg",i=a(0);function r(e,t){var a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var r=d3.forceSimulation();Object.assign(this,{laps:10},a,{gradients:[],rails:[],tick:0,time:0,finalStanding:[]});var o=document.createElementNS(n,"g");o.setAttribute("id","gTrack");var s=document.createElementNS(n,"g");s.setAttribute("id","gCars"),e instanceof SVGElement&&(e.appendChild(o),e.appendChild(s)),Object.defineProperties(this,{simulation:{get:function get(){return r}},svg:{get:function get(){return e}},gTrack:{get:function get(){return o}},gCars:{get:function get(){return s}}}),Array.isArray(a.gradients)?this.setTrack(a.gradients.map(function(e){return new i(e)})):Array.isArray(a.trackPieces)&&this.setTrack(a.trackPieces.map(function(e){return new i(e)})),Array.isArray(t)&&this.setCars(t)}r.fromJson=function(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;return t instanceof SVGElement||(t=document.querySelector("svg")),new r(t,e.cars,e)},Object.defineProperties(r.prototype,{init:{enumerable:!0,value:function value(){var _this4=this;if(!(this.svg instanceof SVGElement))throw new Error("RaceTrack.init requires valid svg element!");this.svg.getElementById("gTrack")||this.svg.appendChild(this.gTrack),this.svg.getElementById("gCars")||this.svg.appendChild(this.gCars),this.simulation.force("fCollide",d3.forceCollide(function(e){return e.radius}));var e=a(7);return this.simulation.force("fRailing",e(this.rails)),this.simulation.nodes().forEach(function(e,t){e.lapTimes=[],e.x=-7*(t+1),e.y=5*Math.pow(-1,t),e.vx=.9,e.vy=0,e.trackAhead=_this4.gradients.slice(),e.posn=[]}),this.moveCars(),this.listCars(),this.simulation.alphaDecay(0),this.simulation.velocityDecay(.01),this.simulation.on("tick",function(){_this4.onTick()}),this}},onTick:{value:function value(){var _this5=this;if(this.simulation.nodes(this.simulation.nodes()),requestAnimationFrame(function(e){_this5.time=e}),this.tick++,this.moveCars(),this.listCars(),this.cars.every(function(e){return e.lapTimes.length>_this5.laps})){this.simulation.stop(),this.cars.forEach(function(e){delete e.sphere});var _e6=document.createElement("a");_e6.setAttribute("href","data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(this)));var _t8=new Date;return _e6.setAttribute("download","race-".concat(_t8.getFullYear(),"-").concat(_t8.getMonth()+1,"-").concat(_t8.getDate(),".json")),_e6.innerText="Save race data",document.querySelector("form").appendChild(_e6),void window.dispatchEvent(new CustomEvent("raceEnd",{detail:[this]}))}return this}},moveCars:{value:function value(){var _this6=this;return d3.selectAll("#gCars circle").attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y}),this.simulation.nodes().forEach(function(e,t,a){if(e.nextPiece){var _t9=_this6.gradients.indexOf(e.trackAhead[0]);if(!e.time.some(function(a){return a.lap===e.lapTimes.length&&a.piece===_t9})&&(e.time.push({lap:e.lapTimes.length,piece:_t9,tick:_this6.tick,time:_this6.time}),0===_t9)){if(!_this6.finalStanding.includes(e.name)){e.time.slice(-1).pop();e.lapTimes.push({tick:_this6.tick,time:_this6.time})}e.lapTimes.length>_this6.laps&&(_this6.finalStanding.includes(e.name)||_this6.finalStanding.push(e.name))}e.trackAhead.push(e.trackAhead.shift()),e.nextPiece=!1}if(e.previousPiece&&(e.trackAhead.unshift(e.trackAhead.pop()),e.previousPiece=!1),_this6.finalStanding.includes(e.name)){var _t10=_this6.finalStanding.indexOf(e.name);e.y=Math.min(Math.max(-20,e.y),20),e.x>_this6.gradients[0].x+10*(_this6.cars.length-_t10)&&(e.fx=e.x,e.fy=e.y)}(e.x<_this6.extrema[0][0]-10||e.x>_this6.extrema[0][1]+10||e.y<_this6.extrema[1][0]-10||e.y>_this6.extrema[1][1]+10)&&_this6.simulation.stop()}),this.cars.forEach(function(e){e.posn.push({tick:_this6.tick,time:_this6.time,vx:e.vx,vy:e.vy,x:e.x,y:e.y})}),this}},setTrack:{enumerable:!0,value:function value(e){var _this7=this;this.gradients=e.filter(function(e){return e instanceof i});var t=[0,0];var a=[[0,0],[0,0]],r=[[],[]];this.rails=new Array(2).fill({});var o=[];this.gTrack.innerHTML="",this.gradients.forEach(function(e,i){t[0]+=e.delta[0],t[1]+=e.delta[1],o.push([t[0],t[1]]),e.x=t[0],e.y=t[1],e.force&&_this7.simulation.force("piece"+i,e.force);var s=Math.acos(e.gradient[0]/Math.hypot.apply(Math,_toConsumableArray(e.gradient)));e.gradient[1]<0&&(s=2*Math.PI-s);var c={x1:t[0]+e.width*Math.sin(s),y1:t[1]-e.width*Math.cos(s),x2:t[0]-e.width*Math.sin(s),y2:t[1]+e.width*Math.cos(s)};e.m=(c.y2-c.y1)/(c.x2-c.x1),e.b=-e.m*c.x1+c.y1,e.rail.forEach(function(e,t,a){"number"==typeof e&&(a[t]=[e,e])});var l=document.createElementNS(n,"line");r[0].push({before:[c.x1-e.width*Math.cos(s)*e.rail[0][0],c.y1-e.width*Math.sin(s)*e.rail[0][0]],is:[c.x1,c.y1],after:[c.x1+e.width*Math.cos(s)*e.rail[0][1],c.y1+e.width*Math.sin(s)*e.rail[0][1]]}),r[1].push({before:[c.x2-e.width*Math.cos(s)*e.rail[1][0],c.y2-e.width*Math.sin(s)*e.rail[1][0]],is:[c.x2,c.y2],after:[c.x2+e.width*Math.cos(s)*e.rail[1][1],c.y2+e.width*Math.sin(s)*e.rail[1][1]]}),a[0][0]=Math.min(a[0][0],c.x1,c.x2),a[0][1]=Math.max(a[0][1],c.x1,c.x2),a[1][0]=Math.min(a[1][0],c.y1,c.y2),a[1][1]=Math.max(a[1][1],c.y1,c.y2),Object.entries(c).forEach(function(_ref14){var _ref15=_slicedToArray(_ref14,2),e=_ref15[0],t=_ref15[1];l.setAttribute(e,t)}),l.classList.add("checkpoint"),0===i&&l.classList.add("start-line"),_this7.gTrack.appendChild(l),d3.select("svg #gTrack").append("circle").attr("cx",e.x).attr("cy",e.y).attr("r",0===i?1.5:2).attr("fill",e.color||"whitesmoke").attr("strokeWidth",0===i?"0.5px":"0").attr("stroke",0===i?"white":"none")}),this.extrema=a,r.forEach(function(e,t){e.push(e[0]);var a=document.createElementNS(n,"path"),i=[];e.forEach(function(t,a){0===a?i.push("M"+t.is.join(",")):i.push("C"+[e[a-1].after.join(" "),t.before.join(" "),t.is.join(" ")].join(","))}),a.setAttribute("d",i.join("")),_this7.gTrack.appendChild(a),_this7.rails[t]=a});var s=a[0][1]-a[0][0]+20,c=a[1][1]-a[1][0]+20,l=a[0][0]-10,d=a[1][0]-10;return c>4*s/5?(s=5*c/4,l=(a[0][0]+a[0][1]-s)/2):(c=4*s/5,d=(a[1][0]+a[1][1]-c)/2),this.svg.setAttribute("viewBox","".concat(l," ").concat(d," ").concat(s," ").concat(c)),d3.select("svg").append("g").selectAll("path").data([o]).enter().append("path").attr("d",d3.line().curve(d3.curveBasisClosed)).classed("lane-line",!0),this}},setCars:{enumerable:!0,value:function value(e){return d3.select("svg #gCars").selectAll("circle").data(e).enter().append("circle").classed("car",!0).attr("fill",function(e){return e.color}).attr("stroke",function(e){return e.color2}).attr("stroke-width",function(e){return e.strokeWidth}).attr("r",function(e){return e.r}).attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y}),this.simulation.nodes(e),this.cars=e.slice(),this}},listCars:{enumerable:!0,value:function value(){var _this8=this;var e=[];var t=document.querySelector("output#lapCount"),a=document.querySelector("ol#positions");return this.cars.slice().sort(function(e,t){return 0===e.time.length&&0===t.time.length?0:0===e.time.length?1:0===t.time.length||e.time.length>t.time.length?-1:e.time.length<t.time.length||e.time[e.time.length-1].time>t.time[t.time.length-1].time?1:e.time[e.time.length-1].time<t.time[t.time.length-1].time?-1:0}).forEach(function(n,i){if(!(n.elPositionList instanceof Element)){n.elPositionList=document.createElement("li");var _e7=document.createElement("span");_e7.classList.add("name"),_e7.innerText=n.name,n.elPositionList.appendChild(_e7);var _t11=document.createElement("span");_t11.classList.add("time"),n.elPositionList.appendChild(_t11)}var r=n.elPositionList;if(n.time.length>1){var _a7=n.time.slice().pop();0===i&&(e=n.time.slice(),t.innerHTML="Lap ".concat(n.lapTimes.length," of ").concat(_this8.laps));var o=r.querySelector(".time");if(0===i){var _e8=((_a7.time-n.time[0].time)/1e3).toFixed(2);o.innerText!==_e8&&(o.innerText=_e8),o.classList.remove("fade-out")}else{var _t12=e.filter(function(e){return e.lap===_a7.lap&&e.piece===_a7.piece}).sort(function(e,t){return e.time-t.time})[0];_a7||console.error("lastTime:",_a7),_t12||console.error("leadTime:",_t12);var _i4=(_a7.time-_t12.time)/1e3;_i4=_i4>0?"+"+_i4.toFixed(2):_i4.toFixed(2),o.innerText!==_i4&&(o.classList.remove("fade-out"),n.lapTimes.length<_this8.laps&&setTimeout(function(){o.classList.add("fade-out")},1e3),o.innerText=_i4)}}r.style.order=i,r.setAttribute("order",i+1),a.contains(r)||a.appendChild(r)}),this}}}),e.exports=r},function(e,t){e.exports=function(e){var t=[];function a(a){e.forEach(function(e){t.forEach(function(t){var a=function(e,t){var a=[t.x+t.vx,t.y+t.vy],n=function n(e){return Math.hypot(e.x-a[0],e.y-a[1])},i=e.getTotalLength();var r,o,s,c=16,l=Number.POSITIVE_INFINITY;for(var _t13=0;_t13<=i;_t13+=c){var _a8=e.getPointAtLength(_t13),_i5=n(_a8);_i5<l&&(r=_a8,o=_t13,l=_i5)}if(l>=2*t.radius&&l>=Math.hypot(t.vx,t.vy))return{distance:l};c/=2;for(;c>.5;){var _t14=o-c,_a9=e.getPointAtLength(_t14),d=n(_a9),h=o+c;s=e.getPointAtLength(h);var m=n(s);_t14>=0&&d<l?(r=_a9,o=_t14,l=d):h<=i&&m<l?(r=s,o=h,l=m):c/=2}return{distance:l,after:s,best:r}}(e,t);if(a.distance<=t.radius||a.distance<=Math.hypot(t.vx/2,t.vy/2)){var _e9=[a.after.y-a.best.y,a.best.x-a.after.x];var n=Math.hypot.apply(Math,_toConsumableArray(_e9));_e9=_e9.map(function(e){return e/n});var i=[t.x-a.best.x,t.y-a.best.y];Math.acos((i[0]*_e9[0]+i[1]*_e9[1])/Math.hypot.apply(Math,i))>=Math.PI/2&&(_e9[0]=-_e9[0],_e9[1]=-_e9[1]);var r=t.vx*_e9[0]+t.vy*_e9[1];if(Math.acos(r/Math.hypot(t.vx,t.vy))<Math.PI/2)return;var o=Math.random()+1,s=[],c=0;do{o+=.05,s=[o*r*_e9[0],o*r*_e9[1]],c=Math.hypot(t.x+t.vx-s[0]-a.after.x,t.y+t.vy-s[1]-a.after.y)}while(Math.abs((t.vx-s[0])*_e9[0]+(t.vy-s[1])*_e9[1])<=Math.abs(r)&&c<t.radius&&o<3);if(o<2){var _a10=[-_e9[1],_e9[0]];Math.acos((t.vx*_a10[0]+t.vy*_a10[1])/Math.hypot(t.vx,t.vy))>Math.PI/2&&(_a10[0]*=-1,_a10[1]*=-1);var _n6=t.vx*_a10[0]+t.vy*_a10[1];for(o=.1;Math.hypot(t.vx-s[0],t.vy-s[1])<.6*Math.hypot(t.vx,t.vy)&&o<1;){o+=.1,s[0]-=.1*_n6*_a10[0],s[1]-=.1*_n6*_a10[1]}for(;Math.hypot(t.vx-s[0],t.vy-s[1])>Math.hypot(t.vx,t.vy);){s[0]+=.05*_n6*_a10[0],s[1]+=.05*_n6*_a10[1]}}t.vx-=s[0],t.vy-=s[1]}})})}return a.initialize=function(e){t=e},a}},function(e,t){function a(e){var _this9=this;var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};Object.assign(this,{strokeWidth:1,r:4},t,{trackAhead:[],nextPiece:!1,previousPiece:!1,lapTimes:[],time:[],posn:[]}),Object.defineProperties(this,{name:{enumerable:!0,get:function get(){return e}},radius:{enumerable:!0,get:function get(){return _this9.r+_this9.strokeWidth/2}}})}Object.defineProperties(a.prototype,{}),e.exports=a}]);